<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
		<meta http-equiv="Pragma" content="no-cache">
		<title>è´¦å·ç™»å½•</title>
		<link rel="stylesheet" href='css/style.css' />
	</head>
	<body>
		<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>


		<div class="header" id="header">
			<span id="userInfo"></span>
			<button id="relogin" onclick="logout()">é‡æ–°ç™»å½•</button>
		</div>

		<div id="loadingContainer">
			<div id="LoadingTextview">åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...</div><br>
			<button id="sendDataBtn">æ‰‹åŠ¨è¯·æ±‚</button>
		</div>

		<div class="container" id="loginContainer">
			<h2 onclick="logout()">è·å–è¯¾è¡¨</h2>
			<div id="StateOfServer">
				ç­‰å¾…ğŸ”—åˆ°æœåŠ¡å™¨...
			</div>
			<form id="loginForm">


				<label for="username">å­¦å·:</label>
				<input type="text" id="username" name="username" required>

				<label for="password" onclick="VablePassword()">å¯†ç :</label>
				<input type="password" id="password" name="password" required>

				<label style="display: flex; justify-content: space-between; width: 100%;">
					<div style="width: 50%; display: flex;">
						<input type="checkbox" id="rememberMe" checked="checked"> è®°ä½æˆ‘</input>
					</div>
					<div style="width: 50%; display: flex; justify-content: flex-end;">
						<label for="clearData" onclick="logout()" style="margin: 0; color: red; font-style: italic; text-decoration: underline;">æ¸…é™¤æ•°æ®</label>
					</div>
				</label>

				<button type="button" id="IndexInputBtn" onclick="sendLoginRequest()">æäº¤</button>
			</form>
		</div>

		<div class="response-container" id="responseContainer">

			<div id="schedule-container"></div>
			<pre id="responseData"></pre>
		</div>

		<script src="js/main.js?timestamp=123"></script>


		<div>
			<button id="connectBtn">è¿æ¥æœåŠ¡å™¨</button>
			<input type="number" id="weekNumberInput" placeholder="è¾“å…¥å‘¨æ•° (1-20)" min="1" max="20">
			<button id="requestSpecificWeekBtn">è¯·æ±‚ç‰¹å®šå‘¨æ•°æ®</button>
			<button id="disconnectBtn">æ–­å¼€è¿æ¥</button>
			<button id="viewLocalStorageBtn">æŸ¥çœ‹LocalStorageæ•°æ®</button>
			<button id="ReSendRequestWeekCourseBtn" onclick="ReSendRequestWeekCourse()">åˆ·æ–°</button>
		
		</div>
		<pre id="logs"></pre>

		<script src="js/socketio.js"></script>
		<script src="js/update.js"></script>
		<!--
		<button id="test" onclick="setTimeLineTop()">æµ‹è¯•</button>
		-->
<div class="conceal"></div>
	</body>
</html>

		<!--main.js
let dayName = "æœªçŸ¥æ˜ŸæœŸ";
let WeekName = 0
let ToWeek = 0
let data_n

let rgb_R = 0
let rgb_G = 0
let rgb_B = 0
/*
const todayn = new Date();
const weekdaysn = ['æ˜ŸæœŸå¤©', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
const dayOfWeekn = today.getDay();
//console.log(dayOfWeekn); */


const scheduleTimeDate = [{
		"jcmc": "1",
		"qssj": "08:30",
		"jssj": "09:15"
	},
	{
		"jcmc": "2",
		"qssj": "09:20",
		"jssj": "10:05"
	},
	{
		"jcmc": "3",
		"qssj": "10:20",
		"jssj": "11:05"
	},
	{
		"jcmc": "4",
		"qssj": "11:10",
		"jssj": "11:55"
	},
	{
		"jcmc": "5",
		"qssj": "14:00",
		"jssj": "14:45"
	},
	{
		"jcmc": "6",
		"qssj": "14:50",
		"jssj": "15:35"
	},
	{
		"jcmc": "7",
		"qssj": "15:50",
		"jssj": "16:35"
	},
	{
		"jcmc": "8",
		"qssj": "16:40",
		"jssj": "17:25"
	},
	{
		"jcmc": "9",
		"qssj": "17:30",
		"jssj": "18:15"
	},
	{
		"jcmc": "10",
		"qssj": "19:00",
		"jssj": "19:45"
	},
	{
		"jcmc": "11",
		"qssj": "19:55",
		"jssj": "20:40"
	}
];

window.onload = function() {
	// é¡µé¢åŠ è½½æ—¶ä¸è¦è‡ªåŠ¨è§¦å‘ç™»å½•è¯·æ±‚
	document.getElementById('loadingContainer').style.display = 'none';
	document.getElementById('sendDataBtn').style.display = 'none';
	document.getElementById('connectBtn').style.display = 'none';
	document.getElementById('disconnectBtn').style.display = 'none';
	document.getElementById('viewLocalStorageBtn').style.display = 'none';
	document.getElementById('requestSpecificWeekBtn').style.display = 'none';
	document.getElementById('weekNumberInput').style.display = 'none';
	document.getElementById('ReSendRequestWeekCourseBtn').style.display = 'none';


	// å¦‚æœè®°ä½æˆ‘åŠŸèƒ½å·²å¯ç”¨ï¼Œå¡«å……è¡¨å•
	if (localStorage.getItem("rememberMe") === "true") {
		document.getElementById("username").value = localStorage.getItem("username") || '';
		document.getElementById("password").value = localStorage.getItem("password") || '';
		document.getElementById("rememberMe").checked = true;
		//åœ¨è¡¨å•å¡«å……çš„æƒ…å†µä¸‹è‡ªåŠ¨ç™»å½•
		sendLoginRequest()
	}


};


document.addEventListener("visibilitychange", function() {
	if (document.hidden) {
		console.log("ç½‘é¡µå·²è¿›å…¥åå°æˆ–ä¸å¯è§");
		// åœ¨è¿™é‡Œå¯ä»¥å¤„ç†é¡µé¢è¿›å…¥åå°æ—¶çš„é€»è¾‘
	} else {
		console.log("ç½‘é¡µå¯è§");
		// åœ¨è¿™é‡Œå¯ä»¥å¤„ç†é¡µé¢å˜ä¸ºå¯è§æ—¶çš„é€»è¾‘
	}
});







function getRandomRGBA(afloat) {
	// éšæœºç”Ÿæˆ RGBA é¢œè‰²
	const r = Math.floor(Math.random() * 256); // çº¢è‰²ï¼ˆ0-255ï¼‰
	const g = Math.floor(Math.random() * 256); // ç»¿è‰²ï¼ˆ0-255ï¼‰
	const b = Math.floor(Math.random() * 256); // è“è‰²ï¼ˆ0-255ï¼‰
	//const a = (Math.random()).toFixed(2); // é€æ˜åº¦ï¼ˆ0.00 - 1.00ï¼‰
	const a = afloat
	rgb_R = r
	rgb_G = g
	rgb_B = b


	return `rgba(${r}, ${g}, ${b}, ${a})`;
}

function getRandomRGBA_body() {
	// éšæœºç”Ÿæˆ RGBA é¢œè‰²
	const r = Math.floor(Math.random() * 256); // çº¢è‰²ï¼ˆ0-255ï¼‰
	const g = Math.floor(Math.random() * 256); // ç»¿è‰²ï¼ˆ0-255ï¼‰
	const b = Math.floor(Math.random() * 256); // è“è‰²ï¼ˆ0-255ï¼‰
	//const a = (Math.random()).toFixed(2); // é€æ˜åº¦ï¼ˆ0.00 - 1.00ï¼‰
	const a = 0.1
	rgb_R = r
	rgb_G = g
	rgb_B = b


	return `rgba(${r}, ${g}, ${b}, ${a})`;
}

function setRandomBackgroundColor(Objectbox) {
	const div = document.getElementById(Objectbox);
	div.style.backgroundColor = getRandomRGBA(0.1);
}

function setRandomBackgroundColor_body(Objectbox) {
	const div = document.getElementById(Objectbox);
	div.style.backgroundColor = getRandomRGBA_body();
	//document.body.style.backgroundColor = getRandomRGBA();
	//	const div = document.getElementById("getRandomRGBA_body");
	//	div.style.backgroundColor = getRandomRGBA_body();

}

// é¡µé¢åŠ è½½æ—¶éšæœºæ”¹å˜èƒŒæ™¯é¢œè‰²
//setRandomBackgroundColor_body();
setRandomBackgroundColor_body("header")

function VablePassword() {
	const passwordField = document.getElementById('password');
	const toggleButton = document.getElementById('toggle-password');
	if (passwordField.type === "password") {
		passwordField.type = "text"; // æ˜¾ç¤ºå¯†ç 
		//toggleButton.textContent = "éšè—"; // ä¿®æ”¹æŒ‰é’®æ–‡æœ¬
	} else {
		passwordField.type = "password"; // éšè—å¯†ç 
		//toggleButton.textContent = "æ˜¾ç¤º"; // ä¿®æ”¹æŒ‰é’®æ–‡æœ¬
	}
}


//ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°æœ¬åœ°
function saveUserInfoToLocalStorage(username, password, rememberMe) {
	if (rememberMe) {
		localStorage.setItem("username", username);
		localStorage.setItem("password", password);
		localStorage.setItem("rememberMe", "true");
	} else {
		localStorage.removeItem("username");
		localStorage.removeItem("password");
		localStorage.setItem("rememberMe", "false");
	}
}
//ç­‰å¾…ä¸­åŠ¨ç”»
function updateUIForLoading() {
	document.getElementById('loadingContainer').style.display = 'flex';
}

function updateUIForResponse(responseContainer, responseData, json_data) {
	responseContainer.style.display = 'block';
	displayFormattedData(json_data);
}

function updateUIForResponse_OtherWeek(responseContainer, responseData, json_data) {
	responseContainer.style.display = 'block';
	displayFormattedData_OtherWeek(json_data);
}

function handleRequestError(responseContainer, responseData, error) {
	responseContainer.style.display = 'block';
	responseData.textContent = 'è¯·æ±‚å‡ºé”™: ' + error.message;

	// å°è¯•æ˜¾ç¤ºç¼“å­˜æ•°æ®
	const cachedData = localStorage.getItem("lastSuccessfulData");
	if (cachedData) {
		displayFormattedData(JSON.parse(cachedData), true); // ä¼ å…¥ç¼“å­˜æ•°æ®å¹¶æ ‡è®°ä¸ºç¼“å­˜
	}
}
//éšè—åŠ è½½å®¹å™¨
function hideLoadingContainer() {
	document.getElementById('loadingContainer').style.display = 'none';
}
//è®¡ç®—å‘¨æ•°
function calculateWeekNumber(targetDateStr) {
	const startDate = new Date(2025, 1, 10); // 2æœˆ17æ—¥ï¼ˆJavaScriptçš„æœˆä»½ä»0å¼€å§‹ï¼Œæ‰€ä»¥1ä»£è¡¨2æœˆï¼‰
	const targetDate = new Date(targetDateStr);
	const delta = targetDate - startDate;
	const weekNumber = Math.floor(delta / (1000 * 60 * 60 * 24 * 7)) + 1;


	return weekNumber;

}


function getCurrentWeekday() {
	const today = new Date();
	const weekdays = ['æ˜ŸæœŸå¤©', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
	const dayOfWeek = today.getDay(); // 0-6, 0ä»£è¡¨æ˜ŸæœŸå¤©
	return weekdays[dayOfWeek];
}


console.log(getCurrentWeekday());

// æå–è·å–å‘¨æ•°çš„åŠŸèƒ½
function getCurrentWeekNumber() {
	const today = new Date();
	console.log(today);
	const dateStr = today.toISOString().split('T')[0];
	//const weekdaya = getCurrentWeekday(); // è·å–æ˜ŸæœŸå‡ 
	//console.log(`ä»Šå¤©æ˜¯ï¼š${weekdaya}`);
	//æ ¼å¼ç¤ºä¾‹Fri Nov 29 2024 16:31:24 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´)
	console.log("##############");
	const weekdaya = getCurrentWeekday(); // è·å–æ˜ŸæœŸå‡ 
	console.log(`ä»Šå¤©æ˜¯ï¼š${weekdaya}`);
	console.log("##############");

	//const dateStr = today.toISOString().split('T')[0];
	return calculateWeekNumber(dateStr); // å·²ç»å®šä¹‰äº†è®¡ç®—å‘¨æ•°çš„å‡½æ•°
}
/*

// æå–è¯·æ±‚å‘é€å’Œå¤„ç†é€»è¾‘ï¼ˆå·²ç»åºŸå¼ƒï¼‰
// æå–è¯·æ±‚å‘é€å’Œå¤„ç†é€»è¾‘ï¼ˆå·²ç»åºŸå¼ƒï¼‰
// æå–è¯·æ±‚å‘é€å’Œå¤„ç†é€»è¾‘ï¼ˆå·²ç»åºŸå¼ƒï¼‰
// æå–è¯·æ±‚å‘é€å’Œå¤„ç†é€»è¾‘ï¼ˆå·²ç»åºŸå¼ƒï¼‰
// æå–è¯·æ±‚å‘é€å’Œå¤„ç†é€»è¾‘ï¼ˆå·²ç»åºŸå¼ƒï¼‰
// æå–è¯·æ±‚å‘é€å’Œå¤„ç†é€»è¾‘ï¼ˆå·²ç»åºŸå¼ƒï¼‰
async function fetchDataFromServer(username, password, weekNumber, retries) {
	const response = await fetch('http://106.14.181.81:3001/get-data', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json'
		},
		body: JSON.stringify({
			username,
			password,
			weekNumber
		})
	});
	// æå–è¯·æ±‚å‘é€å’Œå¤„ç†é€»è¾‘ï¼ˆå·²ç»åºŸå¼ƒï¼‰

	if (response.status === 503 && retries < 10) {
		return retryRequest(retries);
	}

	if (!response.ok) {
		throw new Error('è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ' + response.status);
	}

// æå–è¯·æ±‚å‘é€å’Œå¤„ç†é€»è¾‘ï¼ˆå·²ç»åºŸå¼ƒï¼‰

	//#	const cachedData = localStorage.getItem("lastSuccessfulData");
	//	if (cachedData) {
	//		displayFormattedData(JSON.parse(cachedData), true); // ä¼ å…¥ç¼“å­˜æ•°æ®å¹¶æ ‡è®°ä¸ºç¼“å­˜
	//	}
	//#	return cachedData;

// æå–è¯·æ±‚å‘é€å’Œå¤„ç†é€»è¾‘ï¼ˆå·²ç»åºŸå¼ƒï¼‰


	return response.json();
}
// æå–è¯·æ±‚å‘é€å’Œå¤„ç†é€»è¾‘ï¼ˆå·²ç»åºŸå¼ƒï¼‰
// æå–è¯·æ±‚å‘é€å’Œå¤„ç†é€»è¾‘ï¼ˆå·²ç»åºŸå¼ƒï¼‰
// æå–è¯·æ±‚å‘é€å’Œå¤„ç†é€»è¾‘ï¼ˆå·²ç»åºŸå¼ƒï¼‰
// æå–è¯·æ±‚å‘é€å’Œå¤„ç†é€»è¾‘ï¼ˆå·²ç»åºŸå¼ƒï¼‰

*/

// é‡è¯•è¯·æ±‚çš„åŠŸèƒ½
function retryRequest(retries) {
	document.getElementById('loadingContainer').querySelector('span').textContent = 'æœåŠ¡å™¨ç¹å¿™ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼';
	return new Promise(resolve => setTimeout(() => resolve(sendLoginRequest(retries + 1)), 2000));
}

// ä¸»å‡½æ•°ï¼šå‘èµ·ç™»å½•è¯·æ±‚ï¼ˆå·²ç»åºŸå¼ƒï¼‰
// ä¸»å‡½æ•°ï¼šå‘èµ·ç™»å½•è¯·æ±‚ï¼ˆå·²ç»åºŸå¼ƒï¼‰
// ä¸»å‡½æ•°ï¼šå‘èµ·ç™»å½•è¯·æ±‚ï¼ˆå·²ç»åºŸå¼ƒï¼‰
// ä¸»å‡½æ•°ï¼šå‘èµ·ç™»å½•è¯·æ±‚ï¼ˆå·²ç»åºŸå¼ƒï¼‰
// ä¸»å‡½æ•°ï¼šå‘èµ·ç™»å½•è¯·æ±‚ï¼ˆå·²ç»åºŸå¼ƒï¼‰
// ä¸»å‡½æ•°ï¼šå‘èµ·ç™»å½•è¯·æ±‚ï¼ˆå·²ç»åºŸå¼ƒï¼‰
// ä¸»å‡½æ•°ï¼šå‘èµ·ç™»å½•è¯·æ±‚ï¼ˆå·²ç»åºŸå¼ƒï¼‰
/*
async function jUNK_sendLoginRequest(retries = 0) {
	//ä»æ–‡æœ¬æ¡†è·å–å†…å®¹
	const username = document.getElementById('username').value;
	const password = document.getElementById('password').value;
	const rememberMe = document.getElementById('rememberMe').checked;
	const responseContainer = document.getElementById('responseContainer');
	const responseData = document.getElementById('responseData');

// ä¸»å‡½æ•°ï¼šå‘èµ·ç™»å½•è¯·æ±‚ï¼ˆå·²ç»åºŸå¼ƒï¼‰
// ä¸»å‡½æ•°ï¼šå‘èµ·ç™»å½•è¯·æ±‚ï¼ˆå·²ç»åºŸå¼ƒï¼‰
// ä¸»å‡½æ•°ï¼šå‘èµ·ç™»å½•è¯·æ±‚ï¼ˆå·²ç»åºŸå¼ƒï¼‰


	if (!username || !password) {
		alert("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼");
		return;
	}
// ä¸»å‡½æ•°ï¼šå‘èµ·ç™»å½•è¯·æ±‚ï¼ˆå·²ç»åºŸå¼ƒï¼‰
	// ä¿å­˜ç”¨æˆ·ä¿¡æ¯å’Œæ›´æ–°UI
	saveUserInfoToLocalStorage(username, password, rememberMe);
	updateUIForLoading();
// ä¸»å‡½æ•°ï¼šå‘èµ·ç™»å½•è¯·æ±‚ï¼ˆå·²ç»åºŸå¼ƒï¼‰
	try {
		// è·å–å½“å‰å‘¨æ•°
		const weekNumber = getCurrentWeekNumber();
		WeekName = weekNumber
		ToWeek = weekNumber
		// è¯·æ±‚æ•°æ®å¹¶å¤„ç†è¿”å›
		const json_data = await fetchDataFromServer(username, password, weekNumber, retries);
// ä¸»å‡½æ•°ï¼šå‘èµ·ç™»å½•è¯·æ±‚ï¼ˆå·²ç»åºŸå¼ƒï¼‰
		displayUserInfo(username, password); // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
		hideLoginContainer(); // éšè—ç™»å½•å®¹å™¨
		updateUIForResponse(responseContainer, responseData, json_data); // æ›´æ–°UIä»¥æ˜¾ç¤ºæ•°æ®
// ä¸»å‡½æ•°ï¼šå‘èµ·ç™»å½•è¯·æ±‚ï¼ˆå·²ç»åºŸå¼ƒï¼‰
		// ä¿å­˜æ•°æ®åˆ° localStorage
		localStorage.setItem("lastSuccessfulData", JSON.stringify(json_data));
	} catch (error) {
		handleRequestError(responseContainer, responseData, error);
	} finally {
		hideLoadingContainer();
	}
	// ä¸»å‡½æ•°ï¼šå‘èµ·ç™»å½•è¯·æ±‚ï¼ˆå·²ç»åºŸå¼ƒï¼‰
}
*/

///////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////

// ç™»å½•è¯·æ±‚
function sendLoginRequest() {
	const username = document.getElementById('username').value;
	const password = document.getElementById('password').value;
	const rememberMe = document.getElementById('rememberMe').checked;
	//	saveUserInfoToLocalStorage(username, password, rememberMe);
	if (!username || !password) {
		alert("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼");
		return;
	}

	// logMessage("æ­£åœ¨è¯·æ±‚ç™»å½•...");
	console.log("æ­£åœ¨è¯·æ±‚ç™»å½•...");


	const userExists = localStorage.getItem("username") === username;
	if (!userExists) {
		NewUserLogin(username, password, rememberMe);

	} else {
		ReturningUserLogin();
	}
}




// æ–°ç”¨æˆ·ç™»å½•é€»è¾‘
function NewUserLogin(username, password, rememberMe) {
	document.getElementById('sendDataBtn').style.display = 'flex';
	updateUIForLoading();
	saveUserInfoToLocalStorage(username, password, rememberMe);
	document.getElementById("sendDataBtn").click();
	document.querySelector("#LoadingTextview").textContent = `æ–°ç”¨æˆ·ï¼Œå³å°†å¼€å§‹é¢„å­˜å­¦æœŸè¯¾è¡¨`;

	//	ReturningUserLogin();



}
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////



async function ReturningUserLogin(retries = 0) {
	try {
		const currentWeek = getCurrentWeekNumber();
		WeekName = currentWeek
		ToWeek = currentWeek
		const weekKey = `week_${currentWeek}`;
		const weekData = localStorage.getItem(weekKey);

		if (weekData) {
			console.log(`ä» LocalStorage è·å–åˆ°ç¬¬ ${currentWeek} å‘¨æ•°æ®`);
			const jsonData = JSON.parse(weekData);

			// æ˜¾ç¤ºè¯¾è¡¨æ•°æ®
			hideLoginContainer();
			displayFormattedData(jsonData);
			document.getElementById('responseContainer').style.display = 'block';

			// è°ƒç”¨ä»æœåŠ¡å™¨è·å–æ•°æ®çš„å‡½æ•°
			fetchWeekDataFromServer(currentWeek, jsonData);
		} else {
			console.log(`LocalStorage ä¸­æœªæ‰¾åˆ°ç¬¬ ${currentWeek} å‘¨æ•°æ®`);
			alert(`æœªæ‰¾åˆ°æœ¬å‘¨æ•°æ®ï¼Œè¯·ç¡®ä¿æ•°æ®å·²é¢„å­˜ã€‚`);
		}
	} catch (error) {
		console.error("ReturningUserLogin å‘ç”Ÿé”™è¯¯:", error);
		if (retries < 3) {
			console.log(`é‡è¯•ç¬¬ ${retries + 1} æ¬¡...`);
			ReturningUserLogin(retries + 1);
		} else {
			alert("åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–é‡æ–°ç™»å½•ã€‚");
		}
	}
}
/**
 * å‘æœåŠ¡å™¨è·å–æŒ‡å®šå‘¨çš„æ•°æ®
 * @param {number} weekNumber - å½“å‰æ˜¾ç¤ºçš„å‘¨æ•°
 * @param {object} localData - æœ¬åœ°å­˜å‚¨çš„ JSON æ•°æ®
 */
function fetchWeekDataFromServer(weekNumber, localData) {
	console.log(`å¼€å§‹è¯·æ±‚æœåŠ¡å™¨ç¬¬ ${weekNumber} å‘¨çš„æ•°æ®...`);

	const username = localStorage.getItem("username");
	const password = localStorage.getItem("password");

	if (!username || !password) {
		console.warn("ç”¨æˆ·åæˆ–å¯†ç ç¼ºå¤±ï¼Œæ— æ³•è¯·æ±‚æ•°æ®æ›´æ–°ã€‚");
		return;
	}

	// ç”Ÿæˆè¯·æ±‚æ ‡ç­¾
	const requestTag = `week_${weekNumber}`;

	const payload = {
		username: username,
		password: password,
		weekNumber: weekNumber,
		tag: requestTag, // æ·»åŠ æ ‡ç­¾
	};

	// å‘é€è¯·æ±‚
	socket.emit('get-data', payload);

	// ç›‘å¬æœåŠ¡å™¨è¿”å›çš„æ•°æ®
	socket.once('data-response', (serverResponse) => {
		const {
			tag,
			data: serverData
		} = serverResponse;

		// æ£€æŸ¥è¿”å›çš„æ•°æ®æ ‡ç­¾æ˜¯å¦åŒ¹é…å½“å‰å‘¨
		if (tag !== requestTag) {
			console.warn(`å¿½ç•¥æ ‡ç­¾ä¸º ${tag} çš„å“åº”ï¼Œå½“å‰è¯·æ±‚æ ‡ç­¾ä¸º ${requestTag}`);
			return;
		}

		console.log(`æ”¶åˆ°æœåŠ¡å™¨è¿”å›çš„ç¬¬ ${weekNumber} å‘¨æ•°æ®`);
		compareAndUpdateLocalStorage(weekNumber, localData, serverData);
	});

	// é”™è¯¯å¤„ç†
	socket.once('error', (error) => {
		console.error(`è·å–ç¬¬ ${weekNumber} å‘¨æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:`, error);
	});
}

/**
 * æ¯”è¾ƒæœåŠ¡å™¨æ•°æ®å’Œæœ¬åœ°æ•°æ®å¹¶æ›´æ–° LocalStorage
 * @param {number} weekNumber - å½“å‰æ˜¾ç¤ºçš„å‘¨æ•°
 * @param {object} localData - æœ¬åœ°å­˜å‚¨çš„ JSON æ•°æ®
 * @param {object} serverData - ä»æœåŠ¡å™¨è¿”å›çš„ JSON æ•°æ®
 */
function compareAndUpdateLocalStorage(weekNumber, localData, serverData) {
	console.log(`å¼€å§‹æ¯”è¾ƒç¬¬ ${weekNumber} å‘¨çš„æ•°æ®...`);

	const serverDataString = JSON.stringify(serverData);
	const localDataString = JSON.stringify(localData);

	if (serverDataString === localDataString) {
		console.log(`ç¬¬ ${weekNumber} å‘¨çš„æ•°æ®æ— æ›´æ–°`);
	} else {
		console.log(`ç¬¬ ${weekNumber} å‘¨çš„æ•°æ®å·²æ›´æ–°ï¼Œæ›¿æ¢ LocalStorage å†…å®¹`);
		localStorage.setItem(`week_${weekNumber}`, serverDataString);
		alert(`ç¬¬ ${weekNumber} å‘¨çš„æ•™åŠ¡è¯¾è¡¨æœ‰æ›´æ–°ï¼å³å°†åˆ·æ–°é¡µé¢è‡ªåŠ¨åŒæ­¥ï¼`);
		//location.reload();
		ReSendRequestWeekCourse();
	}
}
/*
	window.onblur = function() {
	    console.log("ç½‘é¡µå¤±å»ç„¦ç‚¹ï¼Œå¯èƒ½è¿›å…¥åå°");
	    // åœ¨è¿™é‡Œå¯ä»¥å¤„ç†å¤±å»ç„¦ç‚¹çš„é€»è¾‘
	};
	
	window.onfocus = function() {
	    console.log("ç½‘é¡µé‡æ–°è·å¾—ç„¦ç‚¹");
	    // åœ¨è¿™é‡Œå¯ä»¥å¤„ç†é‡æ–°è·å¾—ç„¦ç‚¹çš„é€»è¾‘
	};
*/



///////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////
//å±•ç¤ºç”¨æˆ·ä¿¡æ¯
function displayUserInfo(username, password) {
	document.getElementById('userInfo').textContent = `ç™»å½•è´¦å·: ${username}`;

	document.getElementById('header').style.display = 'block';
}
// ç”¨æˆ·ä¿¡æ¯éƒ¨åˆ†
function displayStudentInfo(studentInfo) {
	const name = studentInfo.XM || "æœªçŸ¥";
	const major = studentInfo.ZYMC || "æœªçŸ¥";
	const term = studentInfo.XNMC || "æœªçŸ¥";
	const pid = studentInfo.XH || "æœªçŸ¥";
	const cid = studentInfo.BJMC || "æœªçŸ¥";
	document.getElementById('userInfo').textContent = `ç”¨æˆ·: ${cid}-${name}-${pid}`;

	document.getElementById('header').style.display = 'block';
	return ``;
	//	return `<div id="userinfo"><p>ç”¨æˆ·: ${name} ${cid} ${pid}</p></div>`;

}

// æ—¥æœŸä¿¡æ¯éƒ¨åˆ†
function displayDateInfo(sjkList, rqazcList, xqjmcMap) {
	const date = sjkList[0].dateDigitSeparator || "æœªçŸ¥æ—¥æœŸ";
	const dayInfo = rqazcList.find(item => item.rq === date);


	//	if (dayInfo) {
	// æ›´æ–°å…¨å±€å˜é‡ dayName
	//dayName = xqjmcMap[dayInfo.xqj.toString()] || "æœªçŸ¥æ˜ŸæœŸ";
	console.log(dayName);
	console.log("####");
	const weekdaya = getCurrentWeekday();
	dayName = weekdaya;
	/*
	const todayn = new Date();
    const weekdaysn = ['æ˜ŸæœŸå¤©', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
    const dayOfWeekn = today.getDay(); // 0-6, 0ä»£è¡¨æ˜ŸæœŸå¤©
//	dayName=dayOfWeekn;*/
	//console.log(dayOfWeekn);
	data_n = date;
	//return `<div id="datainfo"><p>ç°åœ¨: ${data_n} ${dayName} ç¬¬${WeekName}å‘¨</p></div>`;
	return ``;
	//} else {
	//	return `<li>æ—¥æœŸå¼‚å¸¸ï¼</li>`;
	//}
}


// æ ¹æ®èŠ‚æ¬¡èŒƒå›´è·å–æ—¶é—´åŒºé—´

function getScheduleTimeRange(range) {
	const scheduleTimeDate = [{
			"jcmc": "1",
			"qssj": "08:30",
			"jssj": "09:15"
		},
		{
			"jcmc": "2",
			"qssj": "09:20",
			"jssj": "10:05"
		},
		{
			"jcmc": "3",
			"qssj": "10:20",
			"jssj": "11:05"
		},
		{
			"jcmc": "4",
			"qssj": "11:10",
			"jssj": "11:55"
		},
		{
			"jcmc": "5",
			"qssj": "14:00",
			"jssj": "14:45"
		},
		{
			"jcmc": "6",
			"qssj": "14:50",
			"jssj": "15:35"
		},
		{
			"jcmc": "7",
			"qssj": "15:50",
			"jssj": "16:35"
		},
		{
			"jcmc": "8",
			"qssj": "16:40",
			"jssj": "17:25"
		},
		{
			"jcmc": "9",
			"qssj": "17:30",
			"jssj": "18:15"
		},
		{
			"jcmc": "10",
			"qssj": "19:00",
			"jssj": "19:45"
		},
		{
			"jcmc": "11",
			"qssj": "19:55",
			"jssj": "20:40"
		}
	];

	// è§£æä¼ å…¥çš„èŠ‚æ¬¡èŒƒå›´ï¼Œå‡è®¾æ ¼å¼ä¸º "1-2èŠ‚"
	const [startLesson, endLesson] = range.split('-').map(Number);

	// è·å–å¯¹åº”èŠ‚æ¬¡çš„å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´
	const startTime = scheduleTimeDate[startLesson - 1].qssj; // éœ€è¦å‡å» 1ï¼Œå› ä¸ºæ•°ç»„æ˜¯ä» 0 å¼€å§‹çš„
	const endTime = scheduleTimeDate[endLesson - 1].jssj;

	// è¿”å›æ—¶é—´åŒºé—´
	return `${startTime}-${endTime}`;
}


/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////


// æ˜¾ç¤ºä»Šæ—¥è¯¾è¡¨
function displayTodayCourses(kbList) {
	let todaySchedule = ''; // ä»Šæ—¥è¯¾ç¨‹
	const scheduleByDay = {};

	// ç»„ç»‡è¯¾ç¨‹æŒ‰æ˜ŸæœŸåˆ†ç±»
	kbList.forEach(course => {
		const ncour = course.jc || "æœªçŸ¥èŠ‚æ¬¡"; // èŠ‚æ¬¡ï¼ˆå¦‚ "1-2èŠ‚"ï¼‰
		const teacher = course.xm || "æœªçŸ¥è€å¸ˆ"; // è€å¸ˆ
		const courseName = course.jxbmc || "æœªçŸ¥è¯¾ç¨‹"; // è¯¾ç¨‹åç§°
		const newText = courseName.slice(0, -5); // å»é™¤å5ä½å­—ç¬¦
		const location = course.cdmc || "æœªçŸ¥åœ°ç‚¹"; // ä¸Šè¯¾åœ°ç‚¹
		const week = course.xqjmc || "æœªçŸ¥æ˜ŸæœŸ"; // æ˜ŸæœŸ

		// å¦‚æœæ²¡æœ‰è¯¥æ˜ŸæœŸçš„è®°å½•ï¼Œåˆå§‹åŒ–ä¸ºç©ºæ•°ç»„
		if (!scheduleByDay[week]) {
			scheduleByDay[week] = [];
		}

		// æå–èŠ‚æ¬¡çš„æ•°å­—éƒ¨åˆ†ï¼ˆä¾‹å¦‚ "1-2èŠ‚" -> "1-2"ï¼‰
		const lessonRange = ncour.replace('èŠ‚', ''); // å»æ‰â€œèŠ‚â€å­—ï¼Œå¾—åˆ°â€œ1-2â€è¿™æ ·çš„æ ¼å¼

		// è·å–èŠ‚æ¬¡æ—¶é—´åŒºé—´ï¼Œä¾‹å¦‚ "1-2"
		const timeRange = getScheduleTimeRange(lessonRange); // è·å–èŠ‚æ¬¡å¯¹åº”çš„æ—¶é—´èŒƒå›´

		// å°†è¯¾ç¨‹æ·»åŠ åˆ°å¯¹åº”æ˜ŸæœŸçš„åˆ—è¡¨ä¸­ï¼Œé™„åŠ æ—¶é—´åŒºé—´
		scheduleByDay[week].push(
			`<div class="dashed-border"></div><div class="ToadyCouseDetial_Ncourse">${ncour}</div><div class="ToadyCouseDetial_timeRange">${timeRange}</div><div class="ToadyCouseDetial_Location">${location}</div><div class="ToadyCouseDetial_Name"> ${newText},</div> `
		);
	});

	// ç¡®ä¿å½“å‰æ—¥æœŸçš„ key å­˜åœ¨
	if (scheduleByDay[dayName] && scheduleByDay[dayName].length > 0) {
		todaySchedule = `<div id="Todaybox" class="body_box"><div id="today-daytitle">ä»Šæ—¥è¯¾è¡¨ ${dayName}</div>`;
		scheduleByDay[dayName].forEach(course => {
			todaySchedule += `<div class="ToadyCouseDetial">${course}</div>`; // ä½¿ç”¨ <h3> æ˜¾ç¤ºè¯¾ç¨‹
		});
		todaySchedule += `</div>`;
	} else {
		// å½“å¤©æ²¡æœ‰è¯¾ç¨‹æ—¶çš„æç¤º
		todaySchedule = `
            <div id="Todaybox" class="body_box">
                <div id="today-daytitle">ä»Šæ—¥è¯¾è¡¨ ${data_n} ç¬¬${WeekName}å‘¨ ${dayName} </div>
                <div class="no-courses">ä»Šå¤©æ²¡æœ‰è¯¾ç¨‹å®‰æ’</div>
            </div>
        `;
	}
	//console.log("inputHtml");
	//console.log("original input text:", todaySchedule);
	console.log(processTodayCoursesAsText(todaySchedule));
	//processTodayCoursesAsText(todaySchedule);
	//console.log(todaySchedule);
	// è¿”å›è¯¾ç¨‹è¡¨ HTML
	return processTodayCoursesAsText(todaySchedule);

}


function processTodayCoursesAsText(inputHtml) {
	// è·å–å½“å‰æ—¶é—´
	const now = new Date();
	const currentTime = now.getHours() * 60 + now.getMinutes();

	// ç”¨äºåŒ¹é…æ—¶é—´æ®µçš„æ­£åˆ™ï¼ˆå…¨å±€åŒ¹é…ï¼‰
	const timeRegex = /(\d{1,2}:\d{2})-(\d{1,2}:\d{2})/g;

	// åˆå§‹åŒ–ç»“æœ
	let resultHtml = inputHtml;
	let foundCurrentCourse = false; // æ ‡è®°æ˜¯å¦å·²æ‰¾åˆ°æ­£åœ¨ä¸Šçš„è¯¾ç¨‹
	let closestNextCourseBlock = null; // ç”¨äºå­˜å‚¨æœ€æ¥è¿‘çš„ä¸‹ä¸€èŠ‚è¯¾ç¨‹å—
	let closestTimeDiff = Infinity; // ç”¨äºå­˜å‚¨æœ€æ¥è¿‘ä¸‹ä¸€èŠ‚è¯¾çš„æ—¶é—´å·®
	let allCoursesEndTime = 0; // ç”¨äºè®°å½•æ‰€æœ‰è¯¾ç¨‹çš„æœ€æ™šç»“æŸæ—¶é—´

	// éå†æ‰€æœ‰åŒ¹é…çš„æ—¶é—´æ®µ
	const matches = [...inputHtml.matchAll(timeRegex)];

	matches.forEach((match) => {
		const startTimeStr = match[1];
		const endTimeStr = match[2];
		const startTime = startTimeStr.split(':').reduce((h, m) => parseInt(h) * 60 + parseInt(m));
		const endTime = endTimeStr.split(':').reduce((h, m) => parseInt(h) * 60 + parseInt(m));

		// æ›´æ–°æ‰€æœ‰è¯¾ç¨‹çš„æœ€æ™šç»“æŸæ—¶é—´
		allCoursesEndTime = Math.max(allCoursesEndTime, endTime);

		// æ‰¾åˆ°æ—¶é—´æ®µé™„è¿‘çš„è¯¾ç¨‹å—
		const matchIndex = match.index;
		const courseStart = inputHtml.lastIndexOf('<div class="ToadyCouseDetial_Ncourse">', matchIndex);
		const courseEnd = inputHtml.indexOf('</div>', matchIndex) + 6;
		const fullBlock = inputHtml.substring(courseStart, courseEnd);

		console.log("Matched block:", fullBlock);

		// åˆ¤æ–­å½“å‰æ—¶é—´å’Œè¯¾ç¨‹æ—¶é—´çš„å…³ç³»
		if (currentTime >= startTime && currentTime <= endTime && !foundCurrentCourse) {
			console.log("Current course found.");
			// åœ¨æ•´ä¸ªè¯¾ç¨‹å—å¤–é¢åŠ ä¸Š <p>ï¼Œæ ‡è®°â€œæ­£åœ¨ä¸Šè¿™èŠ‚è¯¾â€
			const wrappedBlock =
				`<div id="NextClassingTitleBox"><div class="crying-face-container"><style>.crying-face-container{width:15px;height:15px;position:relative;display: inline-block;}.face{width:100%;height:100%;background-color:yellow;border-radius:50%;position:relative;}.eye{width:15%;height:15%;background-color:black;border-radius:50%;position:absolute;top:25%;}.eye.left{left:20%;}.eye.right{right:20%;}.mouth{width:60%;height:25%;border:1px solid black;border-radius:0 0 50% 50%;position:absolute;bottom:20%;left:50%;transform:translateX(-50%) rotate(180deg);}.tear{width:10%;height:15%;background-color:blue;border-radius:50%;position:absolute;bottom:10%;animation:fall 1s infinite;}.tear.left{left:20%;}.tear.right{right:20%;}@keyframes fall{0%{bottom:10%;opacity:1;}50%{bottom:30%;opacity:0.5;}100%{bottom:10%;opacity:1;}}</style><div class="face"><div class="eye left"></div><div class="eye right"></div><div class="mouth"></div><div class="tear left"></div><div class="tear right"></div></div></div><div id="Classing">æ­£åœ¨ä¸Šè¿™èŠ‚è¯¾</div></div><br>${fullBlock}`;
			resultHtml = resultHtml.replace(fullBlock, wrappedBlock);
			foundCurrentCourse = true; // æ ‡è®°å·²æ‰¾åˆ°æ­£åœ¨ä¸Šçš„è¯¾ç¨‹
		} else if (currentTime < startTime) {
			// å¦‚æœå½“å‰æ—¶é—´å°äºè¯¾ç¨‹å¼€å§‹æ—¶é—´ï¼Œè®¡ç®—æ—¶é—´å·®
			const timeDiff = startTime - currentTime;

			// æ›´æ–°æœ€è¿‘çš„ä¸‹ä¸€èŠ‚è¯¾ç¨‹å—
			if (timeDiff < closestTimeDiff) {
				closestTimeDiff = timeDiff;
				closestNextCourseBlock = fullBlock;
			}
		}
	});

	// å¦‚æœæœªæ ‡è®°â€œæ­£åœ¨ä¸Šçš„è¯¾ç¨‹â€ï¼Œä½†æ‰¾åˆ°æœ€æ¥è¿‘çš„â€œä¸‹ä¸€èŠ‚è¯¾â€ï¼Œåˆ™æ ‡è®°ä¸ºâ€œä¸‹ä¸€èŠ‚è¯¾â€
	if (!foundCurrentCourse && closestNextCourseBlock) {
		console.log("Marking closest next course.");
		const wrappedBlock =
			`<div id="NextClassAlarmTitleBox"><div class="runner-container" style="width: 15px; height: 15px; position: relative; margin: 0;"><style>.runner-container {width: 200px; height: 200px; position: relative; margin: 50px auto;} .body {position: absolute; top: 20%; left: 50%; width: 10%; height: 30%; background-color: black; transform: translateX(-50%);} .head {position: absolute; top: 0; left: 50%; width: 20%; height: 20%; background-color: black; border-radius: 50%; transform: translateX(-50%);} .arm {position: absolute; width: 10%; height: 30%; background-color: black; top: 25%; transform-origin: top center;} .arm.left {left: 30%; transform: rotate(45deg); animation: swing-left 1s infinite;} .arm.right {right: 30%; transform: rotate(-45deg); animation: swing-right 1s infinite;} .leg {position: absolute; width: 10%; height: 40%; background-color: black; bottom: 0; transform-origin: top center;} .leg.left {left: 30%; transform: rotate(-45deg); animation: run-left 1s infinite;} .leg.right {right: 30%; transform: rotate(45deg); animation: run-right 1s infinite;} @keyframes swing-left {0%, 100% {transform: rotate(-45deg);} 50% {transform: rotate(30deg);}} @keyframes swing-right {0%, 100% {transform: rotate(-45deg);} 50% {transform: rotate(30deg);}} @keyframes run-left {0%, 100% {transform: rotate(-450deg);} 50% {transform: rotate(300deg);}} @keyframes run-right {0%, 100% {transform: rotate(450deg);} 50% {transform: rotate(-300deg);}}</style><div class="body"></div><div class="head"></div><div class="arm left"></div><div class="arm right"></div><div class="leg left"></div><div class="leg right"></div></div><div id="Nextclass">è¿™æ˜¯ä¸‹ä¸€èŠ‚è¯¾</div></div><br>${closestNextCourseBlock}`;
		resultHtml = resultHtml.replace(closestNextCourseBlock, wrappedBlock);
	}

	// å¦‚æœå½“å‰æ—¶é—´æ™šäºæ‰€æœ‰è¯¾ç¨‹ç»“æŸæ—¶é—´ï¼Œåˆ™æ¸…ç©ºæ‰€æœ‰è¯¾ç¨‹å†…å®¹ï¼Œæ˜¾ç¤ºâ€œä»Šæ—¥è¯¾å·²ç»ä¸Šå®Œâ€
	if (currentTime > allCoursesEndTime) {
		console.log("All courses finished for today.");
		resultHtml = ` <div id="Todaybox" class="body_box"><p>ä»Šæ—¥è¯¾å·²ç»ä¸Šå®Œ</p></div>`;
	}

	console.log("Final result:", resultHtml);
	return resultHtml; // è¿”å›å¤„ç†åçš„ HTML
}
//V1




/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////


function displayWeekCourses(kbList) {
	// ä»localStorageè¯»å–Displaymethodçš„å€¼
	let displayMethod = localStorage.getItem('Displaymethod');
	console.log(displayMethod)
	// å¦‚æœDisplaymethodä¸å­˜åœ¨ï¼Œè®¾ç½®é»˜è®¤å€¼ä¸ºdisplayWeekCourses_Tableå¹¶æ‰§è¡Œ
	if (!displayMethod) {
		displayMethod = 'displayWeekCourses_Table';
		localStorage.setItem('Displaymethod', displayMethod);
	}

	// æ ¹æ®Displaymethodçš„å€¼æ‰§è¡Œå¯¹åº”çš„å‡½æ•°
	let weekSchedule;
	if (displayMethod === 'displayWeekCourses_Table') {
		weekSchedule = displayWeekCourses_Table(kbList);
	} else if (displayMethod === 'displayWeekCourses_Text') {
		weekSchedule = displayWeekCourses_Text(kbList);
	}

	// è¿”å›weekSchedule
	return weekSchedule;
}



function SwitchDisplayWeekCourses() {
	// ä»localStorageè¯»å–Displaymethodçš„å€¼
	let displayMethod = localStorage.getItem('Displaymethod');

	// åˆ¤æ–­Displaymethodçš„å€¼å¹¶è¿›è¡Œåˆ‡æ¢
	if (displayMethod === 'displayWeekCourses_Table') {
		localStorage.setItem('Displaymethod', 'displayWeekCourses_Text');
	} else if (displayMethod === 'displayWeekCourses_Text') {
		localStorage.setItem('Displaymethod', 'displayWeekCourses_Table');
	}

	// æ‰§è¡ŒReSendRequestWeekCourseå‡½æ•°
	ReSendRequestWeekCourse();
}
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////









///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////////////
function displayWeekCourses_Table(kbList) {
	// åˆå§‹åŒ–è¡¨æ ¼ç»“æ„
	let weekSchedule = `
        <div id="Weekbox" class="body_box">
		<div class="dashed-border" id="TimeLine"></div>
		<div id="PowerLineBox" >
		    <div id="PowerLineCircle"></div>
		    <div id="PowerLine_line"></div>
		</div>


		    <div id="CyBox">
        <div id="CyBox_Text1" class="PowerLineSText">æœªçŸ¥</div>
        <div id="CyBox_Text2" class="PowerLineSText">N/Aé’Ÿ</div>
    </div>

            <div id="week-title" onclick="SwitchDisplayWeekCourses()">æœ¬å‘¨æ˜¯:ç¬¬${WeekName}å‘¨</div>
            <table border="1" cellspacing="0" cellpadding="5" style="border-collapse: collapse;">
                <thead id="TableHorizontalTitle">
                    <tr>
                        <th id="TableFirstGrid">èŠ‚æ¬¡</th>
                        <th id="TableWeekTitle1">ä¸€</th>
                        <th id="TableWeekTitle2">äºŒ</th>
                        <th id="TableWeekTitle3">ä¸‰</th>
                        <th id="TableWeekTitle4">å››</th>
                        <th id="TableWeekTitle5">äº”</th>
                        <th id="TableWeekTitle6">å…­</th>
                        <th id="TableWeekTitle7">æ—¥</th>
                    </tr>
                </thead>
                <tbody>
    `;

	// åˆå§‹åŒ–è¯¾è¡¨æ•°æ®ç»“æ„
	const scheduleTable = Array.from({
		length: 11
	}, () => ({
		"ä¸€": null,
		"äºŒ": null,
		"ä¸‰": null,
		"å››": null,
		"äº”": null,
		"å…­": null,
		"æ—¥": null
	}));

	// ä¸ºæ¯é—¨è¯¾ç¨‹åˆ†é…é¢œè‰²
	const courseColors = {};
	kbList.forEach(course => {
		const courseName = course.jxbmc || "æœªçŸ¥è¯¾ç¨‹";
		if (!courseColors[courseName]) {
			courseColors[courseName] = getRandomRGBA(0.25);
		}
	});

	// éå†è¯¾ç¨‹è¡¨ï¼Œå¡«å……åˆ°å¯¹åº”çš„è¡¨æ ¼ä½ç½®
	kbList.forEach(course => {
		const ncour = course.jc || "æœªçŸ¥èŠ‚æ¬¡"; // è¯¾ç¨‹èŠ‚æ¬¡
		const courseName = course.jxbmc || "æœªçŸ¥è¯¾ç¨‹"; // è¯¾ç¨‹åç§°
		const newText = courseName.slice(0, -5); // å»æ‰æœ€åäº”ä¸ªå­—ç¬¦
		const location = course.cdmc || "æœªçŸ¥åœ°ç‚¹"; // ä¸Šè¯¾åœ°ç‚¹
		const weekFull = course.xqjmc || "æœªçŸ¥æ˜ŸæœŸ"; // æ˜ŸæœŸå‡ ï¼ˆå®Œæ•´ï¼‰

		// å°†â€œæ˜ŸæœŸä¸€â€è½¬ä¸ºâ€œä¸€â€
		const week = weekFull.replace("æ˜ŸæœŸ", "");

		// è§£æèŠ‚æ¬¡èŒƒå›´ï¼Œä¾‹å¦‚ "3-4èŠ‚"
		const match = ncour.match(/^(\d+)-(\d+)èŠ‚$/);
		if (match) {
			const start = parseInt(match[1]);
			const end = parseInt(match[2]);

			// å¡«å……åˆ°å¯¹åº”èŠ‚æ¬¡å’Œæ˜ŸæœŸçš„å•å…ƒæ ¼
			if (scheduleTable[start - 1][week] === null) {
				scheduleTable[start - 1][week] = {
					rowspan: end - start + 1,
					content: `${newText}<br>${location}`,
					color: courseColors[courseName] // è·å–è¯¾ç¨‹å¯¹åº”é¢œè‰²
				};

				// å°†å…¶ä½™èŠ‚æ¬¡æ ‡è®°ä¸ºå·²è¢«åˆå¹¶
				for (let i = start; i < end; i++) {
					scheduleTable[i][week] = "MERGED";
				}
			}
		}
	});

	// æ„å»ºè¡¨æ ¼å†…å®¹
	for (let i = 0; i < scheduleTable.length; i++) {
		const time = scheduleTimeDate[i]; // è·å–å½“å‰èŠ‚æ¬¡çš„æ—¶é—´
		const startTime = time.qssj; // å¼€å§‹æ—¶é—´
		const endTime = time.jssj; // ç»“æŸæ—¶é—´

		// åœ¨èŠ‚æ¬¡åé¢æ·»åŠ æ—¶é—´å¹¶è®¾ç½®å­—ä½“è¾ƒå°
		weekSchedule +=
			`<tr><td id="NCouser${i + 1}">${i + 1}èŠ‚<br><span class="ClassTableTimetie" style="font-size: 12px; color: #666;">${startTime} <br>~<br> ${endTime}</span></td>`;
		["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "æ—¥"].forEach(day => {
			const cell = scheduleTable[i][day];
			if (cell === "MERGED") {
				// è·³è¿‡å·²è¢«åˆå¹¶çš„å•å…ƒæ ¼
				return;
			}
			if (cell && cell.rowspan > 1) {
				// è¾“å‡ºå¸¦åˆå¹¶çš„å•å…ƒæ ¼
				weekSchedule +=
					`<td rowspan="${cell.rowspan}" style="background-color: ${cell.color};">${cell.content}</td>`;
			} else {
				// è¾“å‡ºæ™®é€šå•å…ƒæ ¼
				weekSchedule +=
					`<td style="background-color: rgba(0,0,0,0.03); border: 1px dashed #ccc;">${cell ? cell.content : ""}</td>`;
			}
		});
		weekSchedule += `</tr>`;
	}

	// ç»“æŸè¡¨æ ¼ç»“æ„
	weekSchedule += `
                </tbody>
            </table>
        </div>
    `;

	return weekSchedule;
}

//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////



////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////
function getElementTotalHeight(id) {
	const element = document.getElementById(id);
	const style = window.getComputedStyle(element);

	// è·å–å…ƒç´ å†…å®¹çš„é«˜åº¦ï¼ˆä¸åŒ…å«è¾¹æ¡†å’Œå¤–è¾¹è·ï¼‰
	const height = parseFloat(style.height);

	// è·å–è¾¹æ¡†çš„å®½åº¦ï¼ˆä¸Šä¸‹ã€å·¦å³ï¼‰
	const borderTop = parseFloat(style.borderTopWidth);
	const borderBottom = parseFloat(style.borderBottomWidth);

	// è·å–å†…è¾¹è·çš„å¤§å°ï¼ˆä¸Šä¸‹ã€å·¦å³ï¼‰
	const paddingTop = parseFloat(style.paddingTop);
	const paddingBottom = parseFloat(style.paddingBottom);

	// è·å–å¤–è¾¹è·çš„å¤§å°ï¼ˆä¸Šä¸‹ï¼‰
	const marginTop = parseFloat(style.marginTop);
	const marginBottom = parseFloat(style.marginBottom);

	// è®¡ç®—æ€»é«˜åº¦ï¼ˆå†…å®¹é«˜åº¦ + å†…è¾¹è· + è¾¹æ¡† + å¤–è¾¹è·ï¼‰
	const totalHeight = height + paddingTop + paddingBottom + borderTop + borderBottom + marginTop + marginBottom;
	//console.log(totalHeight)
	return totalHeight;
}
/////////////////////////////////////////////////
function getElementTotalWidth(id) {
	const element = document.getElementById(id);
	const style = window.getComputedStyle(element);

	// è·å–å…ƒç´ å†…å®¹çš„å®½åº¦ï¼ˆä¸åŒ…å«è¾¹æ¡†å’Œå¤–è¾¹è·ï¼‰
	const width = parseFloat(style.width);

	// è·å–è¾¹æ¡†çš„å®½åº¦ï¼ˆå·¦å³ï¼‰
	const borderLeft = parseFloat(style.borderLeftWidth);
	const borderRight = parseFloat(style.borderRightWidth);

	// è·å–å†…è¾¹è·çš„å¤§å°ï¼ˆå·¦å³ï¼‰
	const paddingLeft = parseFloat(style.paddingLeft);
	const paddingRight = parseFloat(style.paddingRight);

	// è·å–å¤–è¾¹è·çš„å¤§å°ï¼ˆå·¦å³ï¼‰
	const marginLeft = parseFloat(style.marginLeft);
	const marginRight = parseFloat(style.marginRight);

	// è®¡ç®—æ€»å®½åº¦ï¼ˆå†…å®¹å®½åº¦ + å·¦å³å†…è¾¹è· + å·¦å³è¾¹æ¡† + å·¦å³å¤–è¾¹è·ï¼‰
	const totalWidth = width + paddingLeft + paddingRight + borderLeft + borderRight + marginLeft + marginRight;

	//console.log(totalWidth);
	return totalWidth;
}
////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////
// è·å–å½“å‰æ—¶é—´å¹¶è¿”å›å¯¹åº”çŠ¶æ€
function getClassStatus() {
	const now = new Date();
	const currentTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
	let result = '';

	// å¦‚æœå½“å‰æ—¶é—´åœ¨ç¬¬ä¸€èŠ‚è¯¾ä¹‹å‰
	if (currentTime < scheduleTimeDate[0].qssj) {
		result = 'NotStarted'; // è¯¾æœªå¼€å§‹
	} else if (currentTime > scheduleTimeDate[scheduleTimeDate.length - 1].jssj) {
		// å¦‚æœå½“å‰æ—¶é—´åœ¨æœ€åä¸€èŠ‚è¯¾ä¹‹å
		result = 'End'; // è¯¾ç¨‹ç»“æŸ
	} else {
		// åˆ¤æ–­å½“å‰æ—¶é—´åœ¨ä¸¤èŠ‚è¯¾ä¹‹é—´è¿˜æ˜¯åœ¨æŸä¸€èŠ‚è¯¾ä¸­
		let currentClass = null;
		let nextClass = null;

		for (let i = 0; i < scheduleTimeDate.length; i++) {
			const classInfo = scheduleTimeDate[i];

			// å¦‚æœå½“å‰æ—¶é—´åœ¨æŸèŠ‚è¯¾çš„æ—¶é—´èŒƒå›´å†…
			if (currentTime >= classInfo.qssj && currentTime <= classInfo.jssj) {
				currentClass = classInfo;
				const elapsedMinutes = calculateElapsedMinutes(classInfo.qssj, currentTime);
				result = `Classing ${currentClass.jcmc} å·²ä¸Šè¯¾ ${elapsedMinutes} åˆ†é’Ÿ`;
				break;
			}

			// å¦‚æœå½“å‰æ—¶é—´åœ¨ä¸¤èŠ‚è¯¾ä¹‹é—´
			if (currentTime > classInfo.jssj && i < scheduleTimeDate.length - 1 && currentTime < scheduleTimeDate[i + 1]
				.qssj) {
				nextClass = scheduleTimeDate[i + 1];
				const minutesToNextClass = calculateElapsedMinutes(currentTime, nextClass.qssj);
				result = `Breaking ${nextClass.jcmc} è·ç¦»ä¸‹ä¸€èŠ‚è¯¾è¿˜æœ‰ ${minutesToNextClass} åˆ†é’Ÿ`;
				break;
			}
		}
	}
	//console.log(result)
	return result;
}

// è®¡ç®—æ—¶é—´å·®ï¼ˆå•ä½ï¼šåˆ†é’Ÿï¼‰
function calculateElapsedMinutes(startTime, endTime) {
	const [startHour, startMinute] = startTime.split(':').map(Number);
	const [endHour, endMinute] = endTime.split(':').map(Number);

	const startDate = new Date();
	startDate.setHours(startHour, startMinute, 0);

	const endDate = new Date();
	endDate.setHours(endHour, endMinute, 0);

	const diffMilliseconds = endDate - startDate;
	return Math.floor(diffMilliseconds / (1000 * 60)); // è½¬æ¢ä¸ºåˆ†é’Ÿ
}
////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////

function setTimeLineTop() {

	//getElementTotalWidth('TableHorizontalTitle')
	//è·å–ç›’padding
	// è·å–ç›’å­çš„ padding
	const paddingTop = parseFloat(window.getComputedStyle(document.getElementById("Weekbox")).paddingTop);
	//console.log("paddingTop", paddingTop);


	// è·å–åŸºç¡€é«˜åº¦ï¼ˆweek-title å’Œ TableFirstGrid çš„é«˜åº¦ä¹‹å’Œï¼‰
	const baseHeight = getElementTotalHeight('week-title') + getElementTotalHeight('TableFirstGrid') + paddingTop;



	// è·å–å½“å‰è¯¾ç¨‹çŠ¶æ€
	const classStatus = getClassStatus();

	let topPosition = baseHeight; // åˆå§‹ä½ç½®ä¸ºåŸºç¡€é«˜åº¦

	// å¤„ç†è¯¾ç¨‹çŠ¶æ€
	if (classStatus === 'NotStarted') {
		// è¯¾ç¨‹æœªå¼€å§‹ï¼Œç›´æ¥è®¾ç½® top ä¸ºåŸºç¡€é«˜åº¦
		topPosition = baseHeight;
		document.getElementById('CyBox_Text1').textContent = ` ä¸€å¤©`;
		document.getElementById('CyBox_Text2').textContent = ` è¿˜æ²¡æ¥`;
	} else if (classStatus.startsWith('Classing')) {
		// æ­£åœ¨ä¸Šè¯¾ï¼Œè®¡ç®—å·²ä¸Šè¯¾çš„åˆ†é’Ÿæ•°
		//console.log("classing")
		const classingInfo = classStatus.split(' ');
		//console.log("classing", classingInfo)

		const currentClassIndex = parseInt(classingInfo[1]) - 1; // å½“å‰èŠ‚æ¬¡
		//console.log("classing", currentClassIndex)
		const elapsedMinutes = parseInt(classingInfo[3]);
		//console.log("classing", elapsedMinutes)
		// è®¡ç®—ä¹‹å‰èŠ‚æ¬¡çš„æ€»é«˜åº¦
		let previousClassesHeight = 0;
		for (let i = 0; i < currentClassIndex; i++) {
			previousClassesHeight += getElementTotalHeight('NCouser' + (i + 1))-1;
			//console.log("classing td", i + 1)
		}

		// è·å–å½“å‰èŠ‚æ¬¡çš„é«˜åº¦
		const currentClassHeight = getElementTotalHeight('NCouser' + (currentClassIndex + 1));

		// è®¡ç®—å·²ç»ä¸Šè¯¾çš„æ¯”ä¾‹
		const classingHeight = (elapsedMinutes / 45) * currentClassHeight;

		// è®¾ç½® TimeLine çš„ top
		topPosition = baseHeight + previousClassesHeight + classingHeight;
		ElseMinutes=45-elapsedMinutes;
		document.getElementById('CyBox_Text1').textContent = ` è·ä¸‹è¯¾`;
		document.getElementById('CyBox_Text2').textContent = ` ${ElseMinutes}min`;
	} else if (classStatus.startsWith('Breaking')) {
		const classingInfo = classStatus.split(' ');
		const ElseMinutes = parseInt(classingInfo[3]);



		// è¯¾é—´ä¼‘æ¯ï¼Œè®¡ç®—ä¹‹å‰èŠ‚æ¬¡çš„æ€»é«˜åº¦
		const nextClassIndex = parseInt(classStatus.split(' ')[1]) - 1;

		let previousClassesHeight = 0;
		for (let i = 0; i < nextClassIndex; i++) {
			previousClassesHeight += getElementTotalHeight('NCouser' + (i + 1))-1;
		}

		// è®¾ç½® TimeLine çš„ top
		topPosition = baseHeight + previousClassesHeight;
		document.getElementById('CyBox_Text1').textContent = ` ä¼‘æ¯ä¸­`;
		document.getElementById('CyBox_Text2').textContent = ` è¯¾é—´`;



	} else if (classStatus === 'End') {
		// è¯¾ç¨‹ç»“æŸï¼Œè®¡ç®—æ‰€æœ‰èŠ‚æ¬¡çš„æ€»é«˜åº¦
		let totalClassHeight = 0;
		for (let i = 0; i < scheduleTimeDate.length; i++) {
			totalClassHeight += getElementTotalHeight('NCouser' + (i + 1))-1;
		}

		// è®¾ç½® TimeLine çš„ top
		topPosition = baseHeight + totalClassHeight;
		document.getElementById('CyBox_Text1').textContent = ` ç»“æŸäº†`;
		document.getElementById('CyBox_Text2').textContent = ` ä¸€å¤©`;
	}

	// è®¾ç½® id ä¸º TimeLine çš„å…ƒç´ çš„ top å€¼
	document.getElementById('TimeLine').style.top = topPosition + 'px';
//åˆå§‹åŒ–å®½åº¦
	const TimeLineWidth = getElementTotalWidth('TableHorizontalTitle');
	document.getElementById('TimeLine').style.width = TimeLineWidth + 'px';
	
	setPowerTimeLineTop()
	
	////////////
	
	
	//const today1 = new Date();
	//console.log(today1)
	//const test1129 = today1.getDay();
	//console.log("today",test1129);
}

function setPowerTimeLineTop() {
    // è·å–å‘¨è§†å›¾çš„å·¦ä¾§å¡«å……
    const paddingLeft = parseFloat(window.getComputedStyle(document.getElementById("Weekbox")).paddingLeft);
    const baseWidth = getElementTotalWidth('TableFirstGrid') + paddingLeft;

    // è·å–æ—¶é—´è½´çš„é¡¶éƒ¨ä½ç½®
    const TimeLineTop = parseFloat(window.getComputedStyle(document.getElementById("TimeLine")).top);
    const PowerTimeLineTop = TimeLineTop - 5;
    document.getElementById('PowerLineBox').style.top = PowerTimeLineTop + 'px';

    // è·å–ä»Šå¤©æ˜¯æ˜ŸæœŸå‡ 
    const today = new Date();
    let DayOfWeek = today.getDay();
    if (DayOfWeek === 0) {//å¤§å‘
        DayOfWeek = 7; // å°†å‘¨æ—¥è½¬æ¢ä¸º 7
    }

    // è®¡ç®—ä¹‹å‰åˆ—çš„æ€»å®½åº¦
    let previousWeekWidth = 0;
    for (let i = 1; i < DayOfWeek; i++) {
        const weekTitleWidth = getElementTotalWidth('TableWeekTitle' + i);
        if (!isNaN(weekTitleWidth)) {
            previousWeekWidth += weekTitleWidth - 1; // å‡å»åˆ†éš”çº¿å®½åº¦
        }
    }

    // è®¾ç½® PowerLineBox çš„å·¦ä¾§ä½ç½®
    const PowerTimeLineleft = baseWidth + previousWeekWidth;
    document.getElementById('PowerLineBox').style.left = PowerTimeLineleft + 'px';

    // è®¾ç½® PowerLineBox çš„å®½åº¦
    const todayWidth = getElementTotalWidth('TableWeekTitle' + DayOfWeek);
    if (!isNaN(todayWidth)) {
        document.getElementById('PowerLineBox').style.width = todayWidth + 'px';
    }

    // è°ƒæ•´ CyBox çš„å­—ä½“å¤§å°
    const timeLineWidth = getElementTotalWidth('TableFirstGrid') / 3;
    document.getElementById('CyBox').style.fontSize = (timeLineWidth / 3) * 1.4 + 'px';

    // è°ƒç”¨å…¶ä»–æ ·å¼è®¾ç½®å‡½æ•°
    SetCyBoxStyle();
}

function SetCyBoxStyle(){
	const TimeLineTop = parseFloat(window.getComputedStyle(document.getElementById("TimeLine")).top);
	document.getElementById('CyBox').style.top = TimeLineTop + 'px';


}
   //let num = 1;
   setInterval(function () {
      // num ++;
      // console.log(num);
   	   setTimeLineTop();
   
   }, 1000);

// è·å– week-title å’Œ TableFirstGrid çš„æ€»é«˜åº¦ï¼ˆåŒ…æ‹¬å¤–è¾¹è·ï¼‰
//const weekTitleHeight = getElementTotalHeight('week-title');
//const tableFirstGridHeight = getElementTotalHeight('TableFirstGrid');

//console.log('week-title æ€»é«˜åº¦:', weekTitleHeight);
//console.log('TableFirstGrid æ€»é«˜åº¦:', tableFirstGridHeight);
////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////




////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////

function createVerticalRotationEffect({
	containerId,
	textClass,
	radius = 3,
	centerZ = 15,
	speed = 0.05
	

}) {
	centerZ = 15,
	console.log(centerZ,"la");
	const container = document.getElementById(containerId);
	const texts = Array.from(container.getElementsByClassName(textClass));
	let angle = 0;

	function update() {
		angle += speed;
		texts.forEach((text, index) => {
			const currentAngle = angle + index * Math.PI; // ä¸¤æ®µæ–‡å­—ç›¸éš”180åº¦
			const y = radius * Math.sin(currentAngle); // è°ƒæ•´Yåæ ‡
			const z = centerZ + radius * Math.cos(currentAngle); // è°ƒæ•´Zåæ ‡

			const scale = z / (centerZ * 2); // æ ¹æ®Zè½´è·ç¦»è°ƒæ•´ç¼©æ”¾
			const opacity = scale > 0 ? scale : 0;

			text.style.transform = `
				translate3d(-50%, ${y}px, ${z}px)
				scale(${1 + scale})
			`;
			text.style.opacity = opacity;
		});

		requestAnimationFrame(update);
	}

	update();
}


///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////

function displayWeekCourses_Text(kbList) {
	let weekSchedule =
		`<div id="Weekbox" class="body_box"><div id="week-title" onclick="SwitchDisplayWeekCourses()">æœ¬å‘¨è¯¾è¡¨:ç¬¬${WeekName}å‘¨</div>`; // æœ¬å‘¨è¯¾è¡¨

	const scheduleByDay = {};

	// ç»„ç»‡è¯¾ç¨‹æŒ‰æ˜ŸæœŸåˆ†ç±»
	kbList.forEach(course => {
		const ncour = course.jc || "æœªçŸ¥èŠ‚æ¬¡";
		const teacher = course.xm || "æœªçŸ¥è€å¸ˆ";
		const courseName = course.jxbmc || "æœªçŸ¥è¯¾ç¨‹";
		const originalText = courseName;
		const newText = originalText.slice(0, -5); // å»é™¤å5ä½å­—ç¬¦
		const location = course.cdmc || "æœªçŸ¥åœ°ç‚¹";
		const week = course.xqjmc || "æœªçŸ¥æ˜ŸæœŸ";

		// å¦‚æœæ²¡æœ‰è¯¥æ˜ŸæœŸçš„è®°å½•ï¼Œåˆå§‹åŒ–ä¸ºç©ºæ•°ç»„
		if (!scheduleByDay[week]) {
			scheduleByDay[week] = [];
		}

		// å°†è¯¾ç¨‹æ·»åŠ åˆ°å¯¹åº”æ˜ŸæœŸçš„åˆ—è¡¨ä¸­
		scheduleByDay[week].push(`${ncour}: ${newText}, ${teacher}, ${location}`);
	});

	// æ·»åŠ æœ¬å‘¨è¯¾è¡¨
	for (const [day, courses] of Object.entries(scheduleByDay)) {

		weekSchedule += `<h3 class="day-header">${day}</h3>`;
		courses.forEach(course => {
			weekSchedule += `<p>${course}</p>`; // ä½¿ç”¨ <p> æ˜¾ç¤ºå…¶ä»–è¯¾ç¨‹
		});

	}
	weekSchedule += `</div>`;

	return weekSchedule;
}


/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
//////////////////


// ç¡è§‰è¯¾ä¿¡æ¯éƒ¨åˆ†
function displaySleepCourses(sjkList) {
	let output = "<br><h3>ç¡è§‰è¯¾å®‰æ’ğŸ¤£:</h3>";
	sjkList.forEach(course => {
		const teacher = course.jsxm || "æœªçŸ¥è€å¸ˆ";
		const courseName = course.kcmc || "æœªçŸ¥è¯¾ç¨‹";
		const location = course.cdmc || "æœªçŸ¥åœ°ç‚¹";
		const week = course.qsjsz || "æœªçŸ¥æ—¶é—´";
		output += `<p>${week},${courseName},${teacher},${location}</p>`;
	});
	return output;
}



//é€‰æ‹©å‘¨
function displayWeekChoose() {
	let output =
		'<div id="OtherWeekbox" class="body_box"><h3>æŸ¥è¯¢å…¶ä»–å‘¨è¯¾è¡¨</h3><select id="week-select" class="custom-select">';

	// ç”Ÿæˆ 1 åˆ° 20 å‘¨çš„é€‰é¡¹
	output += '<option value="" disabled selected>è¯·é€‰æ‹©å‘¨æ•°</option>';
	for (let i = 1; i <= 20; i++) {
		output += `<option value="${i}">${i} å‘¨</option>`;
	}

	output += '</select>';

	output += '<button id="TrunToAimWeek" type="button" onclick="sendRequestOtherWeekCourse()">æŸ¥è¯¢</button>'
	output += '<button id="TrunToNextWeek" type="button" onclick="sendRequestNextWeekCourse()">ä¸‹å‘¨è¯¾è¡¨</button>'

	return output;


}

//å…¶ä»–å‘¨æ ·å¼æ•´ç†
function displayFormattedData_OtherWeek(json_data, isCached = false) {
	const scheduleContainer = document.getElementById('schedule-container');
	let output = "";

	const studentInfo = json_data.xsxx || {};
	output += displayStudentInfo(studentInfo); // ç”¨æˆ·ä¿¡æ¯éƒ¨åˆ†


	if (json_data.sjkList && json_data.sjkList.length > 0) {
		//output += displayDateInfo(json_data.sjkList, json_data.rqazcList, json_data.xqjmcMap); // æ—¥æœŸä¿¡æ¯éƒ¨åˆ†
		output += `<div id="Weekbox_OtherWeek" class="body_box"><h3>å…¶ä»–å‘¨è¯¾è¡¨: ç¬¬${WeekName}å‘¨ä¸¨ä»Šå¤©æ˜¯ç¬¬${ToWeek}å‘¨</h3>`

		output += displayWeekCourses(json_data.kbList);
		output += "</div>"
		output += displayWeekChoose();

		output += '<button id="ReturnToCurrentWeek" type="button" onclick="sendLoginRequest()">è¿”å›æœ¬å‘¨</button></div>'


		//output += displaySleepCourses(json_data.sjkList); // ç¡è§‰è¯¾ä¿¡æ¯éƒ¨åˆ†
	} else {
		output += "<p>è¯¾ç¨‹åˆ—è¡¨ä¸ºç©ºæˆ–ç¼ºå¤±</p>";
	}

	if (isCached) {
		output = `<p>ï¼ˆæ˜¾ç¤ºä¸Šæ¬¡æˆåŠŸè·å–çš„æ•°æ®ï¼‰</p>${output}`;
	}

	// å°†ç”Ÿæˆçš„ HTML æ’å…¥å®¹å™¨
	scheduleContainer.innerHTML = output;
	setRandomBackgroundColor("Weekbox")
	setRandomBackgroundColor("OtherWeekbox")
	setRandomBackgroundColor_body("header")

}




// ä¸»å‡½æ•°ï¼šç”Ÿæˆå¹¶æ˜¾ç¤ºæ ¼å¼åŒ–æ•°æ®
function displayFormattedData(json_data, isCached = false) {
	const scheduleContainer = document.getElementById('schedule-container');
	let output = "";

	const studentInfo = json_data.xsxx || {};
	output += displayStudentInfo(studentInfo); // ç”¨æˆ·ä¿¡æ¯éƒ¨åˆ†

	if (json_data.sjkList && json_data.sjkList.length > 0) {
		output += displayDateInfo(json_data.sjkList, json_data.rqazcList, json_data.xqjmcMap); // æ—¥æœŸä¿¡æ¯éƒ¨åˆ†
		output += displayTodayCourses(json_data.kbList); // ä»Šæ—¥è¯¾è¡¨

		output += displayWeekCourses(json_data.kbList);
		output += displayWeekChoose();


		//output += displaySleepCourses(json_data.sjkList); // ç¡è§‰è¯¾ä¿¡æ¯éƒ¨åˆ†
	} else {
		output += "<p>è¯¾ç¨‹åˆ—è¡¨ä¸ºç©ºæˆ–ç¼ºå¤±</p>";
	}

	if (isCached) {
		output = `<p>ï¼ˆæ˜¾ç¤ºä¸Šæ¬¡æˆåŠŸè·å–çš„æ•°æ®ï¼‰</p>${output}`;
	}

	// å°†ç”Ÿæˆçš„ HTML æ’å…¥å®¹å™¨
	scheduleContainer.innerHTML = output;
	setRandomBackgroundColor("Todaybox");
	setRandomBackgroundColor("Weekbox");
	setRandomBackgroundColor("OtherWeekbox");
	setRandomBackgroundColor_body("header");
	////////////

	
	createVerticalRotationEffect({
		containerId: "CyBox",
		textClass: "PowerLineSText",
		radius: 20,
		centerZ: 150,
		speed: 0.04
	});




	//////////////////
}
/*

//æŸ¥çœ‹å…¶å®ƒå‘¨è¯¾ç¨‹è¡¨
async function sendRequestOtherWeekCourse(retries = 0) {
	let output = 'å‡½æ•°å·²è¢«è°ƒç”¨';
	const username = document.getElementById('username').value;
	const password = document.getElementById('password').value;

	const responseContainer = document.getElementById('responseContainer');
	const responseData = document.getElementById('responseData');

	// è·å–ä¸‹æ‹‰æ¡†çš„é€‰ä¸­å‘¨æ•°
	const weekSelect = document.getElementById('week-select');
	const weekNumber = weekSelect.value;
	WeekName = weekNumber

	if (!weekNumber) {
		alert("è¯·é€‰æ‹©å‘¨æ•°ï¼");
		return;
	}

	if (!username || !password) {
		alert("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼");
		return;
	}

	// ä¿å­˜ç”¨æˆ·ä¿¡æ¯å’Œæ›´æ–°UI
	// å¯é€‰æ‹©æ˜¯å¦ä¿å­˜è®°ä½æˆ‘
	updateUIForLoading();

	try {
		// è¯·æ±‚æ•°æ®å¹¶å¤„ç†è¿”å›
		const json_data = await fetchDataFromServer(username, password, weekNumber, retries);

		displayUserInfo(username, password); // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
		hideLoginContainer(); // éšè—ç™»å½•å®¹å™¨
		updateUIForResponse_OtherWeek(responseContainer, responseData, json_data); // æ›´æ–°UIä»¥æ˜¾ç¤ºæ•°æ®

		// ä¿å­˜æ•°æ®åˆ° localStorage


	} catch (error) {
		handleRequestError(responseContainer, responseData, error);
	} finally {
		hideLoadingContainer();
	}
}

*/

/*

//æŸ¥çœ‹ä¸‹å‘¨è¯¾ç¨‹è¡¨
async function sendRequestNextWeekCourse(retries = 0) {
	let output = 'å‡½æ•°å·²è¢«è°ƒç”¨';
	const username = document.getElementById('username').value;
	const password = document.getElementById('password').value;

	const responseContainer = document.getElementById('responseContainer');
	const responseData = document.getElementById('responseData');

	// è·å–ä¸‹æ‹‰æ¡†çš„é€‰ä¸­å‘¨æ•°
	const weekSelect = document.getElementById('week-select');
	const weekNumber = parseInt(WeekName) + 1;
	WeekName = weekNumber


	if (!username || !password) {
		alert("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼");
		return;
	}

	// ä¿å­˜ç”¨æˆ·ä¿¡æ¯å’Œæ›´æ–°UI
	// å¯é€‰æ‹©æ˜¯å¦ä¿å­˜è®°ä½æˆ‘
	updateUIForLoading();

	try {
		// è¯·æ±‚æ•°æ®å¹¶å¤„ç†è¿”å›
		const json_data = await fetchDataFromServer(username, password, weekNumber, retries);

		displayUserInfo(username, password); // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
		hideLoginContainer(); // éšè—ç™»å½•å®¹å™¨
		updateUIForResponse_OtherWeek(responseContainer, responseData, json_data); // æ›´æ–°UIä»¥æ˜¾ç¤ºæ•°æ®

		// ä¿å­˜æ•°æ®åˆ° localStorage


	} catch (error) {
		handleRequestError(responseContainer, responseData, error);
	} finally {
		hideLoadingContainer();
	}
}
// ç›‘å¬ä¸‹æ‹‰æ¡†çš„å˜åŒ–
*/

////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////



// æŸ¥çœ‹å…¶å®ƒå‘¨è¯¾ç¨‹è¡¨
// æŸ¥çœ‹å…¶å®ƒå‘¨è¯¾ç¨‹è¡¨
async function sendRequestOtherWeekCourse(retries = 0) {
	let output = 'å‡½æ•°å·²è¢«è°ƒç”¨';
	const username = document.getElementById('username').value;
	const password = document.getElementById('password').value;

	const responseContainer = document.getElementById('responseContainer');
	const responseData = document.getElementById('responseData');

	// è·å–ä¸‹æ‹‰æ¡†çš„é€‰ä¸­å‘¨æ•°
	const weekSelect = document.getElementById('week-select');
	const weekNumber = weekSelect.value;
	WeekName = weekNumber;

	if (!weekNumber) {
		alert("è¯·é€‰æ‹©å‘¨æ•°ï¼");
		return;
	}

	// å¦‚æœé€‰ä¸­å‘¨æ•°ç­‰äº ToWeekï¼Œç›´æ¥è°ƒç”¨ ReturningUserLogin å‡½æ•°
	if (parseInt(weekNumber) === ToWeek) {
		ReturningUserLogin();
		return;
	}

	if (!username || !password) {
		alert("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼");
		return;
	}

	// ä¿å­˜ç”¨æˆ·ä¿¡æ¯å’Œæ›´æ–°UI
	updateUIForLoading();

	try {
		// ä» localStorage è¯»å–æ•°æ®
		const weekKey = `week_${weekNumber}`;
		const localData = localStorage.getItem(weekKey);

		if (localData) {
			console.log(`ä» LocalStorage è·å–åˆ°ç¬¬ ${weekNumber} å‘¨æ•°æ®`);
			const jsonData = JSON.parse(localData);

			// æ˜¾ç¤ºæ•°æ®
			displayUserInfo(username, password); // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
			hideLoginContainer(); // éšè—ç™»å½•å®¹å™¨
			updateUIForResponse_OtherWeek(responseContainer, responseData, jsonData); // æ›´æ–°UIä»¥æ˜¾ç¤ºæ•°æ®

			// è°ƒç”¨æœåŠ¡å™¨æ¥å£æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
			fetchWeekDataFromServer(weekNumber, jsonData);
		} else {
			alert(`æœªæ‰¾åˆ°ç¬¬ ${weekNumber} å‘¨çš„æ•°æ®ï¼Œè¯·ç¡®ä¿æ•°æ®å·²é¢„å­˜æˆ–è”ç½‘è¯·æ±‚æ•°æ®ã€‚`);
		}
	} catch (error) {
		handleRequestError(responseContainer, responseData, error);
	} finally {
		hideLoadingContainer();
	}
}



// æŸ¥çœ‹ä¸‹å‘¨è¯¾ç¨‹è¡¨
async function sendRequestNextWeekCourse(retries = 0) {
	let output = 'å‡½æ•°å·²è¢«è°ƒç”¨';
	const username = document.getElementById('username').value;
	const password = document.getElementById('password').value;

	const responseContainer = document.getElementById('responseContainer');
	const responseData = document.getElementById('responseData');

	// è·å–ä¸‹å‘¨çš„å‘¨æ•°
	const weekNumber = parseInt(WeekName) + 1;
	WeekName = weekNumber;

	if (!username || !password) {
		alert("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼");
		return;
	}
	if (parseInt(weekNumber) === ToWeek) {
		ReturningUserLogin();
		return;
	}

	// ä¿å­˜ç”¨æˆ·ä¿¡æ¯å’Œæ›´æ–°UI
	updateUIForLoading();

	try {
		// ä» localStorage è¯»å–æ•°æ®
		const weekKey = `week_${weekNumber}`;
		const localData = localStorage.getItem(weekKey);

		if (localData) {
			console.log(`ä» LocalStorage è·å–åˆ°ç¬¬ ${weekNumber} å‘¨æ•°æ®`);
			const jsonData = JSON.parse(localData);

			// æ˜¾ç¤ºæ•°æ®
			displayUserInfo(username, password); // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
			hideLoginContainer(); // éšè—ç™»å½•å®¹å™¨
			updateUIForResponse_OtherWeek(responseContainer, responseData, jsonData); // æ›´æ–°UIä»¥æ˜¾ç¤ºæ•°æ®

			// è°ƒç”¨æœåŠ¡å™¨æ¥å£æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
			fetchWeekDataFromServer(weekNumber, jsonData);
		} else {
			alert(`æœªæ‰¾åˆ°ç¬¬ ${weekNumber} å‘¨çš„æ•°æ®ï¼Œè¯·ç¡®ä¿æ•°æ®å·²é¢„å­˜æˆ–è”ç½‘è¯·æ±‚æ•°æ®ã€‚`);
		}
	} catch (error) {
		handleRequestError(responseContainer, responseData, error);
	} finally {
		hideLoadingContainer();
	}
}



////è‡ªåŠ¨åˆ·æ–°
async function ReSendRequestWeekCourse(retries = 0) {
	let output = 'å‡½æ•°å·²è¢«è°ƒç”¨';
	const username = document.getElementById('username').value;
	const password = document.getElementById('password').value;

	const responseContainer = document.getElementById('responseContainer');
	const responseData = document.getElementById('responseData');

	// è·å–ä¸‹å‘¨çš„å‘¨æ•°
	const weekNumber = parseInt(WeekName);
	WeekName = weekNumber;

	if (!username || !password) {
		alert("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼");
		return;
	}
	if (parseInt(weekNumber) === ToWeek) {
		try {
			const currentWeek = getCurrentWeekNumber();
			WeekName = currentWeek
			ToWeek = currentWeek
			const weekKey = `week_${currentWeek}`;
			const weekData = localStorage.getItem(weekKey);

			if (weekData) {
				console.log(`ä» LocalStorage è·å–åˆ°ç¬¬ ${currentWeek} å‘¨æ•°æ®`);
				const jsonData = JSON.parse(weekData);

				// æ˜¾ç¤ºè¯¾è¡¨æ•°æ®
				hideLoginContainer();
				displayFormattedData(jsonData);
				document.getElementById('responseContainer').style.display = 'block';

				// è°ƒç”¨ä»æœåŠ¡å™¨è·å–æ•°æ®çš„å‡½æ•°
				//fetchWeekDataFromServer(currentWeek, jsonData);
			} else {
				console.log(`LocalStorage ä¸­æœªæ‰¾åˆ°ç¬¬ ${currentWeek} å‘¨æ•°æ®`);
				alert(`æœªæ‰¾åˆ°æœ¬å‘¨æ•°æ®ï¼Œè¯·ç¡®ä¿æ•°æ®å·²é¢„å­˜ã€‚`);
			}
		} catch (error) {
			console.error("ReturningUserLogin å‘ç”Ÿé”™è¯¯:", error);
			if (retries < 3) {
				console.log(`é‡è¯•ç¬¬ ${retries + 1} æ¬¡...`);
				ReturningUserLogin(retries + 1);
			} else {
				alert("åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–é‡æ–°ç™»å½•ã€‚");
			}
		}
		return;
	}

	// ä¿å­˜ç”¨æˆ·ä¿¡æ¯å’Œæ›´æ–°UI
	updateUIForLoading();

	try {
		// ä» localStorage è¯»å–æ•°æ®
		const weekKey = `week_${weekNumber}`;
		const localData = localStorage.getItem(weekKey);

		if (localData) {
			console.log(`ä» LocalStorage è·å–åˆ°ç¬¬ ${weekNumber} å‘¨æ•°æ®`);
			const jsonData = JSON.parse(localData);

			// æ˜¾ç¤ºæ•°æ®
			displayUserInfo(username, password); // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
			hideLoginContainer(); // éšè—ç™»å½•å®¹å™¨
			updateUIForResponse_OtherWeek(responseContainer, responseData, jsonData); // æ›´æ–°UIä»¥æ˜¾ç¤ºæ•°æ®

			// è°ƒç”¨æœåŠ¡å™¨æ¥å£æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
			//	fetchWeekDataFromServer(weekNumber, jsonData);
		} else {
			alert(`æœªæ‰¾åˆ°ç¬¬ ${weekNumber} å‘¨çš„æ•°æ®ï¼Œè¯·ç¡®ä¿æ•°æ®å·²é¢„å­˜æˆ–è”ç½‘è¯·æ±‚æ•°æ®ã€‚`);
		}
	} catch (error) {
		handleRequestError(responseContainer, responseData, error);
	} finally {
		hideLoadingContainer();
	}
}



////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////








//éšè—ç™»å½•ç•Œé¢
function hideLoginContainer() {
	document.getElementById('loginContainer').style.display = 'none';
}
//é€€å‡º
function logout() {
	document.getElementById('loginContainer').style.display = 'block';
	document.getElementById('header').style.display = 'none';
	document.getElementById('responseContainer').style.display = 'none';
	localStorage.removeItem("username");
	localStorage.removeItem("password");
	localStorage.setItem("rememberMe", "false");
}




		-->


				<!--
let socket;
	const logs = document.getElementById('logs');
	let isBatchRequest = false; // æ ‡å¿—å½“å‰æ˜¯å¦æ˜¯æ‰¹é‡è¯·æ±‚
	let currentWeek = 0;

	// è‡ªåŠ¨è¿æ¥æœåŠ¡å™¨
	socket = io('ws://106.14.181.81:2345'); // æ›¿æ¢ä¸ºä½ çš„æœåŠ¡å™¨åœ°å€

	socket.on('connect', () => {
		console.log("å·²è¿æ¥åˆ°æœåŠ¡å™¨");
		document.getElementById("StateOfServer").textContent = "å·²ğŸ”—åˆ°æœåŠ¡å™¨";
	});

socket.on('data-response', (response) => {
	// æ£€æŸ¥æ˜¯å¦æ˜¯æ‰¹é‡è¯·æ±‚
	if (isBatchRequest) {
		const weekKey = `week_${currentWeek}`;
		if (response.tag === `week_${currentWeek}`) {
			// ä»…å­˜å‚¨ response.data éƒ¨åˆ†
			localStorage.setItem(weekKey, JSON.stringify(response.data));
			console.log(`ç¬¬ ${currentWeek} å‘¨æ•°æ®å·²å‚¨å­˜åˆ° LocalStorage`);
			document.querySelector("#LoadingTextview").textContent = `ç¬¬ ${currentWeek} å‘¨æ•°æ®å·²å‚¨å­˜åˆ° LocalStorage`;
			processNextWeek();
		} else {
			console.warn(`æ ‡ç­¾ä¸åŒ¹é…ï¼ŒæœŸæœ›: week_${currentWeek}, å®é™…: ${response.tag}`);
		}
	}
});

	socket.on('error', (error) => {
		console.log('æ”¶åˆ°é”™è¯¯: ' + JSON.stringify(error));
		alert(`æ”¶åˆ°é”™è¯¯:`+ JSON.stringify(error));
		if (isBatchRequest) {
			processNextWeek(); // å³ä½¿å‡ºé”™ä¹Ÿä¸ä¸­æ–­æµç¨‹
		}
	});

	socket.on('disconnect', () => {
		console.log('å·²ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
		document.getElementById("StateOfServer").textContent = "å·²ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥";
	});

	function processNextWeek() {
		const username = document.getElementById('username').value;
		const password = document.getElementById('password').value;
		currentWeek++;

		if (currentWeek > 20) {
			console.log('æ‰€æœ‰å‘¨æ•°æ®è¯·æ±‚å®Œæˆ');
			document.getElementById("LoadingTextview").textContent = 'æ‰€æœ‰å‘¨æ•°æ®è¯·æ±‚å®Œæˆ';
			isBatchRequest = false;
			hideLoadingContainer();
			document.getElementById("IndexInputBtn").click();
			return;
		}

		const payload = {
			username: username,
			password: password,
			weekNumber: currentWeek,
			tag: `week_${currentWeek}`
		};

		console.log(`å‘é€ç¬¬ ${currentWeek} å‘¨çš„æ•°æ®è¯·æ±‚: ` + JSON.stringify(payload));
		document.querySelector("#LoadingTextview").textContent = `æ–°ç”¨æˆ·ï¼Œæ­£åœ¨é¢„å­˜ï¼ˆç¬¬ ${currentWeek}/20 å‘¨ï¼‰çš„æ•°æ®`;
		document.getElementById('sendDataBtn').style.display = 'none';
		socket.emit('get-data', payload);
	}

	document.getElementById('sendDataBtn').addEventListener('click', () => {
		if (socket && socket.connected) {
			isBatchRequest = true;
			currentWeek = 0;
			processNextWeek();
		} else {
			console.log('å°šæœªè¿æ¥åˆ°æœåŠ¡å™¨');
			document.querySelector("#LoadingTextview").textContent = 'å°šæœªè¿æ¥åˆ°æœåŠ¡å™¨,æ£€æŸ¥ä½ çš„ç½‘ç»œè®¾ç½®ï¼Œå¹¶ä¸”åˆ·æ–°é¡µé¢';
		}
	});

	document.getElementById('disconnectBtn').addEventListener('click', () => {
		if (socket) {
			socket.disconnect();
			console.log('å·²è¯·æ±‚æ–­å¼€è¿æ¥');
			document.getElementById("StateOfServer").textContent = "å·²ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥";
		} else {
			console.log('å°šæœªè¿æ¥åˆ°æœåŠ¡å™¨');
			document.getElementById("StateOfServer").textContent = "ä½ å°±æ²¡ğŸ”—åˆ°æœåŠ¡å™¨";
		}
	});

	document.getElementById('viewLocalStorageBtn').addEventListener('click', () => {
		console.log('LocalStorage ä¸­çš„å­˜å‚¨å†…å®¹:');
		for (let i = 1; i <= 20; i++) {
			const key = `week_${i}`;
			const value = localStorage.getItem(key);
			console.log(`${key}: ${value}`);
		}
	});


		-->
			<!--åç«¯
from flask import Flask, request, jsonify
from flask_socketio import SocketIO
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
import requests
import json
import os
import time
from datetime import datetime
import logging
from logging.handlers import RotatingFileHandler





# è®¾ç½®æ—¥å¿—è®°å½•
log_formatter = logging.Formatter('%(asctime)s - %(levelname)s - %(message)s')

# æ§åˆ¶å°è¾“å‡º
console_handler = logging.StreamHandler()
console_handler.setFormatter(log_formatter)
console_handler.setLevel(logging.DEBUG)

# æ–‡ä»¶è¾“å‡ºï¼Œæ·»åŠ æ—¥å¿—è½®æ¢
log_file = os.path.join(os.path.dirname(__file__), 'debug.log')
file_handler = RotatingFileHandler(log_file, maxBytes=10*1024*1024, backupCount=3)  # 10MBå¤§å°ï¼Œæœ€å¤šä¿ç•™3ä¸ªå¤‡ä»½
file_handler.setFormatter(log_formatter)
file_handler.setLevel(logging.DEBUG)

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.DEBUG, format='%(asctime)s - %(levelname)s - %(message)s', handlers=[console_handler, file_handler])



app = Flask(__name__)
socketio = SocketIO(app, cors_allowed_origins="*")

# è®¾ç½®CORSå“åº”å¤´
@app.after_request
def apply_cors(response):
    logging.info("#Applying CORS headers")
    response.headers["Access-Control-Allow-Origin"] = "*"
    response.headers["Access-Control-Allow-Headers"] = "Origin, X-Requested-With, Content-Type, Accept"
    response.headers["Access-Control-Allow-Methods"] = "POST, GET, OPTIONS"
    return response


# URL å’Œ POST æ•°æ®
url = "https://jwpd.jsei.edu.cn/kbcx/xskbcxMobile_cxXsKb.html"


# è·å– Cookies å¸¦é‡è¯•æœºåˆ¶
def get_cookies_with_retries(driver, retries=5, delay=1):
    for attempt in range(1, retries + 1):
        try:
            logging.info(f"#Attempting to retrieve cookies (Attempt {attempt})...")
            cookies = driver.get_cookies()
            if cookies:
                cookies_string = "; ".join(f"{cookie['name']}={cookie['value']}" for cookie in cookies)
                logging.info(f"#Successfully retrieved cookies: {cookies_string}")

                # æ£€æŸ¥æ˜¯å¦åŒ…å« org.springframework.web.servlet.i18n.CookieLocaleResolver.LOCALE=en;
                if "org.springframework.web.servlet.i18n.CookieLocaleResolver." in cookies_string:
                    logging.warning("!!!Account or password error, cookies contain invalid fields")
                    socketio.emit('error', {"error": "Invalid account or password"})  # å‘å®¢æˆ·ç«¯å‘é€é”™è¯¯ä¿¡æ¯
                    return None  # è¿”å› None è¡¨ç¤ºé”™è¯¯

                return cookies_string
            else:
                logging.warning("!!!Failed to retrieve cookies, retrying...")
        except Exception as error:
            logging.error(f"!!!Error while retrieving cookies: {error}")
        time.sleep(delay)

    raise Exception("!!!Failed to retrieve cookies after maximum retry attempts")


# è¯·æ±‚ JSON æ•°æ®å¸¦é‡è¯•æœºåˆ¶
def fetch_data_with_retries(headers, retries=5, delay=1):
    data = {
        "xnm": "2024",
        "xqm": "12",
        "zs": f"{weekNumber}",
        "kblx": "1",
        "doType": "app"
    }
    for attempt in range(1, retries + 1):
        try:
            logging.info(f"#Attempting to fetch JSON data (Attempt {attempt})...")
            response = requests.post(url, data=data, headers=headers)
            if response.text and response.text != "null":
                logging.info("#Successfully retrieved JSON data")
                return response.json()
            else:
                logging.warning("#JSON data is empty or 'null', retrying...")
        except Exception as error:
            logging.error(f"#Error fetching JSON data: {error}")
        time.sleep(delay)
    raise Exception("#Failed to fetch JSON data after maximum retry attempts")


# åˆ é™¤å¤±æ•ˆçš„ Cookies
def delete_invalid_cookies(username, password):
    file_path = os.path.join(os.path.dirname(__file__), 'cookies.json')
    if not os.path.exists(file_path):
        logging.info("#Cookies file not found, skipping deletion")
        return
    try:
        logging.info(f"#Deleting invalid cookies, reading file: {file_path}")
        with open(file_path, 'r') as file:
            cookies_file = json.load(file)
        new_cookies_file = [c for c in cookies_file if c['username'] != username or c['password'] != password]
        with open(file_path, 'w') as file:
            json.dump(new_cookies_file, file, indent=2)
        logging.info("#Invalid cookies deleted")
    except Exception as error:
        logging.error(f"!!!Error deleting invalid cookies: {error}")


# Save cookies to file
def save_cookies_to_file(username, password, cookie_string):
    file_path = os.path.join(os.path.dirname(__file__), 'cookies.json')
    cookies_data = {
        "username": username,
        "password": password,
        "cookieString": cookie_string,
        "timestamp": datetime.now().isoformat()
    }
    try:
        logging.info(f"#Saving cookies to file: {file_path}")
        cookies_file = []
        if os.path.exists(file_path):
            # Check if the file is empty
            if os.path.getsize(file_path) > 0:
                with open(file_path, 'r') as file:
                    try:
                        cookies_file = json.load(file)  # Attempt to load file contents
                    except json.JSONDecodeError:
                        logging.warning(f"!!!Invalid file format: {file_path}, reinitializing")
                        cookies_file = []  # Reinitialize as empty if file is invalid
        cookies_file.append(cookies_data)
        with open(file_path, 'w') as file:
            json.dump(cookies_file, file, indent=2)
        logging.info("#Cookies saved successfully")
    except Exception as err:
        logging.error(f"!!!Error saving cookies: {err}")


# æ£€æŸ¥æ˜¯å¦å­˜åœ¨æœ‰æ•ˆçš„ Cookies
def check_for_valid_cookies(username, password):
    file_path = os.path.join(os.path.dirname(__file__), 'cookies.json')
    if not os.path.exists(file_path):
        logging.info(f"#Cookies file not found: {file_path}")
        return None
    try:
        logging.info(f"#Checking for valid cookies, reading file: {file_path}")
        with open(file_path, 'r') as file:
            cookies_file = json.load(file)
        for cookie_data in cookies_file:
            if cookie_data['username'] == username and cookie_data['password'] == password:
                logging.info(f"#Found existing cookies, using: {cookie_data['cookieString']}")
                return cookie_data['cookieString']
    except Exception as error:
        logging.error(f"!!!Error reading or parsing cookies file: {error}")
    return None


def validate_and_get_cookies(username, password):
    cookies_string = check_for_valid_cookies(username, password)

    # å¦‚æœå·²æœ‰çš„ Cookies åŒ…å« 'org.springframework.web.servlet.i18n.CookieLocaleResolver.LOCALE=en;' å­—æ®µï¼Œè®¤ä¸ºè´¦å·å¯†ç é”™è¯¯
    if cookies_string and "org.springframework.web.servlet.i18n.CookieLocaleResolver.LOCALE=en;" in cookies_string:
        logging.warning(f"!!!Account or password error, cookies contain invalid 'LOCALE=en' field")
        socketio.emit('error', {"error": "Invalid account or password"})
        return None  # Return None to indicate an error

    # å¦‚æœ Cookies æ— æ•ˆæˆ–ä¸å­˜åœ¨ï¼Œåˆ™è·å–æ–°çš„ Cookies
    if cookies_string:
        if not are_cookies_valid(cookies_string, username, password):
            logging.info("#Existing cookies are invalid, attempting to retrieve new ones...")
            delete_invalid_cookies(username, password)
            cookies_string = None

    if not cookies_string:
        logging.info("#No valid cookies found, starting to retrieve new cookies...")
        cookies_string = fetch_new_cookies(username, password)

    return cookies_string

def are_cookies_valid(cookies_string, username, password):
    try:
        logging.info("#Checking if existing cookies are valid...")
        headers = {"Cookie": cookies_string}
        response = fetch_data_with_retries(headers)
        if "error" in response:  # If response contains error, cookies are invalid
            logging.warning("!!!Cookies are invalid")
            return False
        logging.info("#Cookies are valid")
        return True
    except Exception as e:
        logging.error(f"!!!Error checking cookies: {e}")
        delete_invalid_cookies(username, password)
        return False
    #            service = Service(r"D:\PY-learn\new\pj1\pythonProject\.venv\src\node_modules\webdriver\chromedriver.exe")  # ä¿®æ”¹ä¸ºæ­£ç¡®çš„ chromedriver è·¯å¾„


def fetch_new_cookies(username, password):
    logging.info("#Starting to fetch new cookies...")
    options = Options()
    options.add_argument("--headless")  # Headless mode
    options.add_argument("--disable-gpu")
    options.add_argument("--no-sandbox")
    chromedriver_path = r"/usr/bin/chromedriver"
    service = Service(chromedriver_path)
    driver = webdriver.Chrome(service=service, options=options)

    try:
        driver.get("https://authserver.jsei.edu.cn/authserver/login?service=https%3A%2F%2Fjwpd.jsei.edu.cn%2Fsso%2Fjznewsixlogin")
        WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.ID, "username")))

        # Enter username and password
        logging.info("#Entering username and password...")
        driver.find_element(By.ID, "username").send_keys(username)
        driver.find_element(By.ID, "password").send_keys(password)
        driver.find_element(By.CLASS_NAME, "auth_login_btn").click()

        # Wait for redirection
        WebDriverWait(driver, 15).until(EC.url_contains("jwpd.jsei.edu.cn"))

        # Get new cookies
        cookies_string = get_cookies_with_retries(driver)

        # Save cookies to file
        save_cookies_to_file(username, password, cookies_string)
    finally:
        driver.quit()

    return cookies_string



is_processing = False  # æ§åˆ¶å¹¶å‘è¯·æ±‚



# Socket.IO å¤„ç†å®¢æˆ·ç«¯è¿æ¥
@socketio.on('connect')
def handle_connect():
    logging.info("#Client connected")
    socketio.emit('message', 'Server connected successfully')

# å¤„ç†å®¢æˆ·ç«¯æ–­å¼€è¿æ¥
@socketio.on('disconnect')
def handle_disconnect():
    logging.info("#Client disconnected")




# å¤„ç† get-data è¯·æ±‚
@socketio.on('get-data')
def handle_get_data(data):
    global is_processing, weekNumber

    if is_processing:
        logging.warning("!!!Server is busy, please try again later")
        socketio.emit('error', {"error": "Server is busy, please try again later"})
        return

    is_processing = True
    username = data.get("username")
    password = data.get("password")
    weekNumber = data.get("weekNumber")
    request_tag = data.get("tag")  # è·å–æ ‡ç­¾
    logging.info(f"#User submitted request, username: {username}, password: {password}, week number: {weekNumber}")

    if not username or not password:
        is_processing = False
        logging.error("!!!Username and password cannot be empty")
        socketio.emit('error', {"error": "Username and password cannot be empty"})
        return

    try:
        # éªŒè¯ç”¨æˆ·åå’Œå¯†ç å¹¶è·å– Cookies
        cookies_string = validate_and_get_cookies(username, password)
        headers = {"Cookie": cookies_string}
        logging.info(f"#Successfully retrieved cookies, requesting data for week {weekNumber}")

        # è·å–è¯¾ç¨‹æ•°æ®
        response_data = fetch_data_with_retries(headers)

        # å°†æ•°æ®æ‰“ä¸Šæ ‡ç­¾
        tagged_response = {
            "tag": request_tag,   # åŒ…å«è¯·æ±‚çš„æ ‡ç­¾
            "data": response_data  # æœåŠ¡å™¨è¿”å›çš„å®é™…æ•°æ®
        }

        # è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯
        socketio.emit('data-response', tagged_response)
        logging.info(f"#Data for week {weekNumber} successfully returned with tag: {request_tag}")

    except Exception as error:
        logging.error(f"!!!An error occurred: {error}")
        socketio.emit('error', {"error": "Request failed", "details": str(error)})

    finally:
        is_processing = False





if __name__ == '__main__':
    logging.info("#Socket.IO application starting...")
    socketio.run(app, host='0.0.0.0', port=2345, allow_unsafe_werkzeug=True)



		-->